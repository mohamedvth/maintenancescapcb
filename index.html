<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCAPCB - Gestion de Maintenance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Styles existants... */
        
        /* Nouveaux styles pour la pagination */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(30, 30, 40, 0.95);
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .pagination-info {
            color: #bdc3c7;
            font-size: 0.95rem;
        }
        
        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .pagination-btn {
            background: rgba(40, 40, 50, 0.95);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95rem;
        }
        
        .pagination-btn:hover {
            background: #e74c3c;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-btn:disabled:hover {
            background: rgba(40, 40, 50, 0.95);
        }
        
        .pagination-pages {
            display: flex;
            gap: 5px;
        }
        
        .page-number {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(40, 40, 50, 0.95);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .page-number:hover, .page-number.active {
            background: #e74c3c;
        }
        
        .page-number.active {
            font-weight: bold;
        }
        
        .items-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }
        
        .items-per-page select {
            background: rgba(40, 40, 50, 0.95);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .pagination-controls {
                width: 100%;
                justify-content: center;
            }
            
            .items-per-page {
                margin-left: 0;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-form">
            <div class="logo">
                <div class="logo-circle">
                    <span style="font-size: 2.5rem; font-weight: bold;">S</span>
                </div>
                <div class="logo-text">SCAPCB</div>
            </div>
            <h2 class="login-title">Accès Administrateur</h2>
            <div class="login-input-group">
                <label for="username"><i class="fas fa-user"></i> Nom d'utilisateur</label>
                <input type="text" id="username" placeholder="Entrez votre nom d'utilisateur" autocomplete="off">
            </div>
            <div class="login-input-group">
                <label for="password"><i class="fas fa-lock"></i> Mot de passe</label>
                <input type="password" id="password" placeholder="Entrez votre mot de passe" autocomplete="off">
                <span class="password-toggle" id="passwordToggle">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <button class="login-btn" id="loginBtn">Se Connecter</button>
            <div class="login-error" id="loginError">Identifiants incorrects. Veuillez réessayer.</div>
            <div class="security-note">
                <i class="fas fa-shield-alt"></i> Veuillez saisir vos identifiants de connexion
            </div>
        </div>
    </div>
    
    <!-- Main Application (hidden until login) -->
    <div class="container" id="mainApp">
        <header>
            <div class="logo">
                <div class="logo-circle">
                    <span style="font-size: 2.5rem; font-weight: bold;">S</span>
                </div>
                <div class="logo-text">SCAPCB</div>
            </div>
            <h1>Système Centralisé d'Administration des Procédures de Contrôle des Bris</h1>
            <p class="subtitle">Application de gestion des interventions de maintenance électrique, mécanique et générale avec suivi des maintenances préventives, correctives et annulées</p>
            
            <div class="header-buttons">
                <button class="export-btn" id="exportExcel">
                    <i class="fas fa-file-excel"></i> Exporter vers Excel
                </button>
                <div class="file-input-container">
                    <button class="import-btn" id="importExcelBtn">
                        <i class="fas fa-file-import"></i> Importer Excel
                    </button>
                    <input type="file" id="importExcel" accept=".xlsx, .xls" style="display: none;">
                </div>
                <button class="sync-btn" id="syncBtn">
                    <i class="fas fa-sync-alt"></i> Synchroniser
                </button>
                <button class="toggle-btn" id="toggleInterventions">
                    <i class="fas fa-eye-slash"></i> Masquer les Interventions
                </button>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </button>
            </div>
        </header>
        
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Interventions Total</div>
                <div class="stat-value" id="totalInterventions">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">En Cours</div>
                <div class="stat-value" id="inProgress">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Terminées</div>
                <div class="stat-value" id="completed">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Équipements</div>
                <div class="stat-value" id="totalEquipment">0</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-tools"></i> <span id="formTitle">Nouvelle Intervention</span></h2>
                <form id="interventionForm">
                    <input type="hidden" id="interventionId">
                    
                    <div class="form-group">
                        <label for="user"><i class="fas fa-user"></i> Utilisateur</label>
                        <input type="text" id="user" required placeholder="Nom de l'utilisateur">
                    </div>
                    
                    <div class="form-group">
                        <label for="matricule"><i class="fas fa-id-card"></i> Matricule</label>
                        <input type="text" id="matricule" required placeholder="Matricule">
                    </div>
                    
                    <div class="form-group">
                        <label for="interventionType"><i class="fas fa-bolt"></i> Type d'intervention</label>
                        <select id="interventionType" required>
                            <option value="">Sélectionner un type</option>
                            <option value="electrique">Maintenance Électrique</option>
                            <option value="mecanique">Maintenance Mécanique</option>
                            <option value="servise-general">Service Général</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenanceType"><i class="fas fa-cogs"></i> Type de maintenance</label>
                        <select id="maintenanceType" required>
                            <option value="">Sélectionner un type</option>
                            <option value="preventif">Maintenance Préventive</option>
                            <option value="corective">Maintenance Corrective</option>
                            <option value="annule">Intervention Annulée</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="priority"><i class="fas fa-exclamation-triangle"></i> Priorité</label>
                        <select id="priority" required>
                            <option value="">Sélectionner une priorité</option>
                            <option value="high">Haute</option>
                            <option value="medium">Moyenne</option>
                            <option value="low">Basse</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="status"><i class="fas fa-tasks"></i> Statut</label>
                        <select id="status" required>
                            <option value="planned">Planifiée</option>
                            <option value="in-progress">En Cours</option>
                            <option value="completed">Terminée</option>
                            <option value="annule">Annulée</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="description"><i class="fas fa-file-alt"></i> Description</label>
                        <textarea id="description" placeholder="Décrivez l'intervention en détail..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="startDate"><i class="fas fa-play-circle"></i> Début d'intervention</label>
                        <input type="datetime-local" id="startDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate"><i class="fas fa-stop-circle"></i> Fin d'intervention</label>
                        <input type="datetime-local" id="endDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="equipment"><i class="fas fa-microchip"></i> Équipement</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="equipment" placeholder="Nom de l'équipement">
                            <button type="button" id="addEquipment" style="width: auto;"><i class="fas fa-plus"></i> Ajouter</button>
                        </div>
                    </div>
                    
                    <div class="equipment-list" id="equipmentList">
                        <p style="text-align: center; color: #95a5a6; padding: 10px;">Aucun équipement ajouté</p>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="cancel-btn" id="cancelEdit" style="display: none;">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                        <button type="submit" id="submitBtn">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="list-section" id="interventionListSection">
                <h2 class="section-title"><i class="fas fa-list"></i> Interventions Enregistrées</h2>
                
                <div class="filter-bar">
                    <select id="filterType">
                        <option value="">Tous les types</option>
                        <option value="electrique">Électrique</option>
                        <option value="mecanique">Mécanique</option>
                        <option value="servise-general">Service Général</option>
                    </select>
                    
                    <select id="filterMaintenance">
                        <option value="">Toutes les maintenances</option>
                        <option value="preventif">Préventive</option>
                        <option value="corective">Corrective</option>
                        <option value="annule">Annulée</option>
                    </select>
                    
                    <select id="filterStatus">
                        <option value="">Tous les statuts</option>
                        <option value="planned">Planifiée</option>
                        <option value="in-progress">En cours</option>
                        <option value="completed">Terminée</option>
                    </select>
                    
                    <input type="text" id="searchInput" placeholder="Rechercher...">
                </div>
                
                <div class="intervention-list" id="interventionList">
                    <div class="no-interventions">
                        <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <p>Aucune intervention enregistrée</p>
                        <p>Commencez par ajouter une nouvelle intervention</p>
                    </div>
                </div>
                
                <!-- Nouveau conteneur de pagination -->
                <div class="pagination-container" id="paginationContainer" style="display: none;">
                    <div class="pagination-info" id="paginationInfo">
                        Affichage de 0 à 0 sur 0 interventions
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="prevPage" disabled>
                            <i class="fas fa-chevron-left"></i> Précédent
                        </button>
                        <div class="pagination-pages" id="pageNumbers"></div>
                        <button class="pagination-btn" id="nextPage" disabled>
                            Suivant <i class="fas fa-chevron-right"></i>
                        </button>
                        <div class="items-per-page">
                            <span>Afficher:</span>
                            <select id="itemsPerPage">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Système de Gestion de Maintenance &copy; <span class="copyright">HAMADA 2025</span></p>
            <p>SCAPCB - Tous droits réservés | Version 4.0 | <span id="sessionStatus">Session sécurisée</span></p>
        </footer>
    </div>

    <script>
        // Login credentials
        const ADMIN_USERNAME = "admin5513090807";
        const ADMIN_PASSWORD = "5513090807**Aa";
        
        // Configuration
        const API_URL = "https://mohamedvth.github.io/maintenancescapcb/";
        const SYNC_INTERVAL = 30000; // 30 seconds
        
        // DOM elements
        const loginOverlay = document.getElementById('loginOverlay');
        const mainApp = document.getElementById('mainApp');
        const loginBtn = document.getElementById('loginBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const passwordToggle = document.getElementById('passwordToggle');
        const sessionStatus = document.getElementById('sessionStatus');
        const syncBtn = document.getElementById('syncBtn');
        const importExcelBtn = document.getElementById('importExcelBtn');
        const importExcelInput = document.getElementById('importExcel');
        
        // Initialize variables
        let interventions = [];
        let equipmentList = [];
        let nextId = 1;
        let isLoggedIn = false;
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 3;
        let isEditing = false;
        let currentEditId = null;
        let syncInterval = null;
        let deviceId = generateDeviceId();
        
        // Variables de pagination
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalPages = 1;
        
        // Generate unique device ID
        function generateDeviceId() {
            return 'device-' + Math.random().toString(36).substr(2, 9);
        }
        
        // Password visibility toggle
        passwordToggle.addEventListener('click', () => {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordToggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                passwordInput.type = 'password';
                passwordToggle.innerHTML = '<i class="fas fa-eye"></i>';
            }
        });
        
        // Login functionality
        loginBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            // Security: limit login attempts
            loginAttempts++;
            if (loginAttempts > MAX_LOGIN_ATTEMPTS) {
                loginError.textContent = "Trop de tentatives échouées. Veuillez réessayer plus tard.";
                loginError.style.display = 'block';
                loginBtn.disabled = true;
                setTimeout(() => {
                    loginBtn.disabled = false;
                    loginAttempts = 0;
                }, 30000); // 30 seconds lockout
                return;
            }
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                // Successful login
                isLoggedIn = true;
                sessionStatus.textContent = "Connecté";
                loginAttempts = 0;
                
                try {
                    // Load data from localStorage
                    const storedData = localStorage.getItem('scapcb-data');
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        interventions = parsedData.interventions || [];
                        nextId = parsedData.nextId || 1;
                    }
                    
                    loginOverlay.style.display = 'none';
                    mainApp.style.display = 'block';
                    renderEquipmentList();
                    renderInterventionList();
                    updateStats();
                    
                    // Start sync interval
                    startSyncInterval();
                    
                    // Initial sync
                    syncData();
                } catch (error) {
                    console.error("Erreur de chargement:", error);
                    loginOverlay.style.display = 'none';
                    mainApp.style.display = 'block';
                    renderEquipmentList();
                    renderInterventionList();
                    updateStats();
                    startSyncInterval();
                    syncData();
                }
            } else {
                // Failed login
                loginError.textContent = `Identifiants incorrects. Tentatives restantes: ${MAX_LOGIN_ATTEMPTS - loginAttempts}`;
                loginError.style.display = 'block';
                usernameInput.style.border = '2px solid #e74c3c';
                passwordInput.style.border = '2px solid #e74c3c';
                
                // Clear password field
                passwordInput.value = '';
            }
        });
        
        // Logout functionality
        logoutBtn.addEventListener('click', () => {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter?')) {
                logout();
            }
        });
        
        // Logout function
        function logout() {
            isLoggedIn = false;
            sessionStatus.textContent = "Session sécurisée";
            mainApp.style.display = 'none';
            loginOverlay.style.display = 'flex';
            usernameInput.value = '';
            passwordInput.value = '';
            loginError.style.display = 'none';
            usernameInput.style.border = '';
            passwordInput.style.border = '';
            
            // Clear any sensitive data from memory
            interventions = [];
            equipmentList = [];
            nextId = 1;
            resetForm();
            
            // Stop sync interval
            stopSyncInterval();
        }
        
        // Start sync interval
        function startSyncInterval() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(syncData, SYNC_INTERVAL);
        }
        
        // Stop sync interval
        function stopSyncInterval() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = null;
        }
        
        // Toggle interventions button
        const toggleBtn = document.getElementById('toggleInterventions');
        const interventionListSection = document.getElementById('interventionListSection');
        let interventionsVisible = true;
        
        toggleBtn.addEventListener('click', () => {
            interventionsVisible = !interventionsVisible;
            
            if (interventionsVisible) {
                interventionListSection.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Masquer les Interventions';
            } else {
                interventionListSection.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Afficher les Interventions';
            }
        });
        
        // DOM elements for the main app
        const interventionForm = document.getElementById('interventionForm');
        const addEquipmentBtn = document.getElementById('addEquipment');
        const equipmentInput = document.getElementById('equipment');
        const equipmentListEl = document.getElementById('equipmentList');
        const interventionListEl = document.getElementById('interventionList');
        const exportExcelBtn = document.getElementById('exportExcel');
        const cancelEditBtn = document.getElementById('cancelEdit');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const interventionIdInput = document.getElementById('interventionId');
        
        // Stats elements
        const totalInterventionsEl = document.getElementById('totalInterventions');
        const inProgressEl = document.getElementById('inProgress');
        const completedEl = document.getElementById('completed');
        const totalEquipmentEl = document.getElementById('totalEquipment');
        
        // Filter elements
        const filterType = document.getElementById('filterType');
        const filterMaintenance = document.getElementById('filterMaintenance');
        const filterStatus = document.getElementById('filterStatus');
        const searchInput = document.getElementById('searchInput');
        
        // Pagination elements
        const paginationContainer = document.getElementById('paginationContainer');
        const paginationInfo = document.getElementById('paginationInfo');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageNumbersEl = document.getElementById('pageNumbers');
        const itemsPerPageSelect = document.getElementById('itemsPerPage');
        
        // Add equipment to the list
        addEquipmentBtn.addEventListener('click', () => {
            const equipment = equipmentInput.value.trim();
            if (equipment) {
                equipmentList.push(equipment);
                equipmentInput.value = '';
                renderEquipmentList();
            }
        });
        
        // Render equipment list
        function renderEquipmentList() {
            equipmentListEl.innerHTML = '';
            
            if (equipmentList.length === 0) {
                equipmentListEl.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 10px;">Aucun équipement ajouté</p>';
                return;
            }
            
            equipmentList.forEach((equipment, index) => {
                const item = document.createElement('div');
                item.className = 'equipment-item';
                item.innerHTML = `
                    <span>${equipment}</span>
                    <button class="remove-equipment" data-index="${index}"><i class="fas fa-trash"></i> Supprimer</button>
                `;
                equipmentListEl.appendChild(item);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-equipment').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    equipmentList.splice(index, 1);
                    renderEquipmentList();
                });
            });
        }
        
        // Handle form submission
        interventionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = document.getElementById('user').value;
            const matricule = document.getElementById('matricule').value;
            const interventionType = document.getElementById('interventionType').value;
            const maintenanceType = document.getElementById('maintenanceType').value;
            const priority = document.getElementById('priority').value;
            const status = document.getElementById('status').value;
            const description = document.getElementById('description').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const id = interventionIdInput.value;
            
            if (!user || !matricule || !interventionType || !maintenanceType || !priority || !status || !startDate || !endDate) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('La date de fin ne peut pas être antérieure à la date de début');
                return;
            }
            
            if (isEditing && id) {
                // Update existing intervention
                const index = interventions.findIndex(i => i.id == id);
                if (index !== -1) {
                    interventions[index] = {
                        ...interventions[index],
                        user,
                        matricule,
                        interventionType,
                        maintenanceType,
                        priority,
                        status,
                        description,
                        start: startDate,
                        end: endDate,
                        equipment: [...equipmentList],
                        updatedAt: new Date().toISOString(),
                        updatedBy: deviceId
                    };
                    
                    showSyncStatus("Intervention mise à jour avec succès", true);
                }
            } else {
                // Create new intervention
                const newIntervention = {
                    id: nextId++,
                    user,
                    matricule,
                    interventionType,
                    maintenanceType,
                    priority,
                    status,
                    description,
                    start: startDate,
                    end: endDate,
                    equipment: [...equipmentList],
                    createdAt: new Date().toISOString(),
                    createdBy: deviceId,
                    updatedAt: null,
                    updatedBy: null
                };
                
                interventions.push(newIntervention);
                showSyncStatus("Intervention enregistrée avec succès", true);
            }
            
            equipmentList = [];
            renderEquipmentList();
            renderInterventionList();
            updateLocalStorage();
            updateStats();
            resetForm();
            
            // Sync changes
            syncData();
        });
        
        // Reset form to initial state
        function resetForm() {
            interventionForm.reset();
            equipmentList = [];
            renderEquipmentList();
            isEditing = false;
            currentEditId = null;
            formTitle.textContent = "Nouvelle Intervention";
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
            cancelEditBtn.style.display = 'none';
            interventionIdInput.value = '';
        }
        
        // Cancel edit mode
        cancelEditBtn.addEventListener('click', resetForm);
        
        // Edit intervention
        function editIntervention(id) {
            const intervention = interventions.find(i => i.id == id);
            if (!intervention) return;
            
            // Fill form with intervention data
            document.getElementById('user').value = intervention.user;
            document.getElementById('matricule').value = intervention.matricule;
            document.getElementById('interventionType').value = intervention.interventionType;
            document.getElementById('maintenanceType').value = intervention.maintenanceType;
            document.getElementById('priority').value = intervention.priority;
            document.getElementById('status').value = intervention.status;
            document.getElementById('description').value = intervention.description || '';
            document.getElementById('startDate').value = intervention.start;
            document.getElementById('endDate').value = intervention.end;
            interventionIdInput.value = intervention.id;
            
            // Set equipment
            equipmentList = [...intervention.equipment];
            renderEquipmentList();
            
            // Change form to edit mode
            isEditing = true;
            currentEditId = id;
            formTitle.textContent = "Modifier Intervention";
            submitBtn.innerHTML = '<i class="fas fa-sync"></i> Mettre à jour';
            cancelEditBtn.style.display = 'block';
            
            // Scroll to form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Delete intervention
        function deleteIntervention(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette intervention?')) {
                interventions = interventions.filter(i => i.id !== id);
                renderInterventionList();
                updateLocalStorage();
                updateStats();
                showSyncStatus("Intervention supprimée avec succès", true);
                
                // If we were editing the deleted item, reset form
                if (isEditing && currentEditId == id) {
                    resetForm();
                }
                
                // Sync changes
                syncData();
            }
        }
        
        // Render intervention list with pagination
        function renderInterventionList() {
            interventionListEl.innerHTML = '';
            
            // Apply filters
            let filteredInterventions = [...interventions];
            
            // Type filter
            if (filterType.value) {
                filteredInterventions = filteredInterventions.filter(i => i.interventionType === filterType.value);
            }
            
            // Maintenance type filter
            if (filterMaintenance.value) {
                filteredInterventions = filteredInterventions.filter(i => i.maintenanceType === filterMaintenance.value);
            }
            
            // Status filter
            if (filterStatus.value) {
                filteredInterventions = filteredInterventions.filter(i => i.status === filterStatus.value);
            }
            
            // Search filter
            if (searchInput.value) {
                const searchTerm = searchInput.value.toLowerCase();
                filteredInterventions = filteredInterventions.filter(i => 
                    i.user.toLowerCase().includes(searchTerm) || 
                    i.matricule.toLowerCase().includes(searchTerm) ||
                    (i.description && i.description.toLowerCase().includes(searchTerm)) ||
                    i.equipment.some(eq => eq.toLowerCase().includes(searchTerm))
                );
            }
            
            // Calculate pagination values
            const totalItems = filteredInterventions.length;
            totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // Ensure current page is within valid range
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (currentPage < 1) {
                currentPage = 1;
            }
            
            // Calculate start and end indices
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const currentPageItems = filteredInterventions.slice(startIndex, endIndex);
            
            // Update pagination info
            paginationInfo.textContent = `Affichage de ${startIndex + 1} à ${endIndex} sur ${totalItems} interventions`;
            
            // Show or hide pagination controls
            if (totalItems > 5) {
                paginationContainer.style.display = 'flex';
            } else {
                paginationContainer.style.display = 'none';
            }
            
            // Enable/disable navigation buttons
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            
            // Render page numbers
            pageNumbersEl.innerHTML = '';
            
            // Always show first page
            if (currentPage > 1) {
                const firstPageBtn = document.createElement('div');
                firstPageBtn.className = 'page-number';
                firstPageBtn.textContent = '1';
                firstPageBtn.addEventListener('click', () => {
                    currentPage = 1;
                    renderInterventionList();
                });
                pageNumbersEl.appendChild(firstPageBtn);
                
                // Show ellipsis if needed
                if (currentPage > 2) {
                    const ellipsis = document.createElement('div');
                    ellipsis.className = 'page-number';
                    ellipsis.textContent = '...';
                    ellipsis.style.cursor = 'default';
                    pageNumbersEl.appendChild(ellipsis);
                }
            }
            
            // Calculate the range of pages to show
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            // Adjust if at the beginning or end
            if (currentPage <= 3) {
                endPage = Math.min(5, totalPages);
            }
            if (currentPage >= totalPages - 2) {
                startPage = Math.max(1, totalPages - 4);
            }
            
            // Render page numbers in range
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('div');
                pageBtn.className = 'page-number';
                if (i === currentPage) {
                    pageBtn.classList.add('active');
                }
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    renderInterventionList();
                });
                pageNumbersEl.appendChild(pageBtn);
            }
            
            // Show ellipsis and last page if needed
            if (currentPage < totalPages - 2) {
                const ellipsis = document.createElement('div');
                ellipsis.className = 'page-number';
                ellipsis.textContent = '...';
                ellipsis.style.cursor = 'default';
                pageNumbersEl.appendChild(ellipsis);
                
                const lastPageBtn = document.createElement('div');
                lastPageBtn.className = 'page-number';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.addEventListener('click', () => {
                    currentPage = totalPages;
                    renderInterventionList();
                });
                pageNumbersEl.appendChild(lastPageBtn);
            }
            
            // Render interventions for current page
            if (currentPageItems.length === 0) {
                interventionListEl.innerHTML = '<div class="no-interventions"><i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 20px;"></i><p>Aucune intervention correspondant aux critères</p></div>';
                return;
            }
            
            // Sort by start date (newest first)
            currentPageItems.sort((a, b) => new Date(b.start) - new Date(a.start));
            
            currentPageItems.forEach(intervention => {
                const card = document.createElement('div');
                card.className = `intervention-card priority-${intervention.priority}`;
                
                // Map types to French labels
                const interventionTypeMap = {
                    'electrique': 'Électrique',
                    'mecanique': 'Mécanique',
                    'servise-general': 'Service Général'
                };
                
                const maintenanceTypeMap = {
                    'preventif': 'Préventive',
                    'corective': 'Corrective',
                    'annule': 'Annulée'
                };
                
                const statusMap = {
                    'planned': 'Planifiée',
                    'in-progress': 'En Cours',
                    'completed': 'Terminée',
                    'annule': 'Annulée'
                };
                
                const statusClassMap = {
                    'planned': 'status-planned',
                    'in-progress': 'status-in-progress',
                    'completed': 'status-completed',
                    'annule': 'status-canceled'
                };
                
                card.innerHTML = `
                    <div class="intervention-header">
                        <div class="intervention-title">${intervention.user} (${intervention.matricule})</div>
                        <div>
                            <span class="intervention-type ${intervention.interventionType}">${interventionTypeMap[intervention.interventionType]}</span>
                            <span class="intervention-type ${intervention.maintenanceType}">${maintenanceTypeMap[intervention.maintenanceType]}</span>
                            <span class="status-badge ${statusClassMap[intervention.status]}">${statusMap[intervention.status]}</span>
                        </div>
                    </div>
                    
                    <div class="intervention-details">
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-calendar-alt"></i> Début</span>
                            <span class="detail-value">${formatDate(intervention.start)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-calendar-alt"></i> Fin</span>
                            <span class="detail-value">${formatDate(intervention.end)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-clock"></i> Durée</span>
                            <span class="detail-value">${calculateDuration(intervention.start, intervention.end)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="fas fa-exclamation-triangle"></i> Priorité</span>
                            <span class="detail-value" style="text-transform: capitalize;">${intervention.priority}</span>
                        </div>
                    </div>
                    
                    ${intervention.description ? `
                    <div class="intervention-description">
                        <div class="description-label"><i class="fas fa-file-alt"></i> Description:</div>
                        <div>${intervention.description}</div>
                    </div>
                    ` : ''}
                    
                    <div class="intervention-equipment">
                        <div class="detail-label"><i class="fas fa-cog"></i> Équipements:</div>
                        ${intervention.equipment.map(eq => `<span class="equipment-tag">${eq}</span>`).join('')}
                    </div>
                    
                    <div class="card-footer">
                        <span class="intervention-id">
                            ID: #${intervention.id} 
                            ${intervention.updatedAt ? `| Mise à jour: ${formatDate(intervention.updatedAt)} <span class="device-badge">${intervention.updatedBy === deviceId ? 'Cet appareil' : 'Autre appareil'}</span>` : `| Créé le: ${formatDate(intervention.createdAt)} <span class="device-badge">${intervention.createdBy === deviceId ? 'Cet appareil' : 'Autre appareil'}</span>`}
                        </span>
                        <div class="action-buttons">
                            <button class="edit-intervention" data-id="${intervention.id}">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="delete-intervention" data-id="${intervention.id}">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    </div>
                `;
                
                interventionListEl.appendChild(card);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.edit-intervention').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.closest('button').dataset.id);
                    editIntervention(id);
                });
            });
            
            document.querySelectorAll('.delete-intervention').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.closest('button').dataset.id);
                    deleteIntervention(id);
                });
            });
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Calculate duration between two dates
        function calculateDuration(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            const diff = endDate - startDate;
            
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            
            return `${hours}h ${minutes}min`;
        }
        
        // Update stats
        function updateStats() {
            totalInterventionsEl.textContent = interventions.length;
            
            const inProgress = interventions.filter(i => i.status === 'in-progress').length;
            inProgressEl.textContent = inProgress;
            
            const completed = interventions.filter(i => i.status === 'completed').length;
            completedEl.textContent = completed;
            
            // Calculate total equipment
            let totalEquipment = 0;
            interventions.forEach(intervention => {
                totalEquipment += intervention.equipment.length;
            });
            totalEquipmentEl.textContent = totalEquipment;
        }
        
        // Update localStorage
        function updateLocalStorage() {
            const appData = {
                interventions: interventions,
                nextId: nextId,
                lastSync: new Date().toISOString()
            };
            localStorage.setItem('scapcb-data', JSON.stringify(appData));
        }
        
        // Export to Excel functionality
        exportExcelBtn.addEventListener('click', () => {
            if (interventions.length === 0) {
                alert("Aucune intervention à exporter!");
                return;
            }
            
            // Prepare data for export
            const data = interventions.map(intervention => {
                return {
                    ID: intervention.id,
                    Utilisateur: intervention.user,
                    Matricule: intervention.matricule,
                    "Type d'intervention": intervention.interventionType,
                    "Type de maintenance": intervention.maintenanceType,
                    Priorité: intervention.priority,
                    Statut: intervention.status,
                    Description: intervention.description,
                    "Début d'intervention": formatDate(intervention.start),
                    "Fin d'intervention": formatDate(intervention.end),
                    Durée: calculateDuration(intervention.start, intervention.end),
                    Équipements: intervention.equipment.join(", "),
                    "Date de création": formatDate(intervention.createdAt),
                    "Créé par": intervention.createdBy,
                    "Dernière mise à jour": intervention.updatedAt ? formatDate(intervention.updatedAt) : "",
                    "Mis à jour par": intervention.updatedBy || ""
                };
            });
            
            // Create worksheet
            const worksheet = XLSX.utils.json_to_sheet(data);
            
            // Create workbook
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Interventions");
            
            // Export to Excel file
            XLSX.writeFile(workbook, "interventions_maintenance.xlsx");
        });
        
        // Import Excel functionality
        importExcelBtn.addEventListener('click', () => {
            importExcelInput.click();
        });
        
        importExcelInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first worksheet
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) {
                    alert("Le fichier Excel est vide ou ne contient pas de données valides");
                    return;
                }
                
                // Map Excel data to intervention format
                const importedInterventions = jsonData.map(row => {
                    // Parse dates from strings
                    const parseDate = (dateStr) => {
                        if (!dateStr) return null;
                        return new Date(dateStr).toISOString();
                    };
                    
                    return {
                        id: row.ID || nextId++,
                        user: row.Utilisateur,
                        matricule: row.Matricule,
                        interventionType: row["Type d'intervention"],
                        maintenanceType: row["Type de maintenance"],
                        priority: row.Priorité,
                        status: row.Statut,
                        description: row.Description,
                        start: parseDate(row["Début d'intervention"]) || new Date().toISOString(),
                        end: parseDate(row["Fin d'intervention"]) || new Date().toISOString(),
                        equipment: row.Équipements ? row.Équipements.split(",").map(eq => eq.trim()) : [],
                        createdAt: parseDate(row["Date de création"]) || new Date().toISOString(),
                        createdBy: row["Créé par"] || deviceId,
                        updatedAt: parseDate(row["Dernière mise à jour"]),
                        updatedBy: row["Mis à jour par"] || null
                    };
                });
                
                // Merge with existing interventions
                interventions = [...interventions, ...importedInterventions];
                
                // Update nextId
                nextId = Math.max(...interventions.map(i => i.id)) + 1;
                
                // Update UI and storage
                renderInterventionList();
                updateLocalStorage();
                updateStats();
                showSyncStatus(`${importedInterventions.length} interventions importées avec succès`, true);
                
                // Reset file input
                importExcelInput.value = '';
                
                // Sync changes
                syncData();
            };
            
            reader.readAsArrayBuffer(file);
        });
        
        // Synchronize data with server
        async function syncData() {
            syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synchronisation...';
            
            try {
                // Get last sync timestamp
                const storedData = localStorage.getItem('scapcb-data');
                const lastSync = storedData ? JSON.parse(storedData).lastSync : null;
                
                // Simulate API call to server
                const response = await fetch(`${API_URL}api/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deviceId: deviceId,
                        interventions: interventions,
                        lastSync: lastSync
                    })
                });
                
                if (!response.ok) throw new Error("Erreur de synchronisation");
                
                const data = await response.json();
                
                // Update interventions with server data
                interventions = data.interventions;
                
                // Update nextId
                nextId = Math.max(...interventions.map(i => i.id), 0) + 1;
                
                // Update UI and storage
                renderInterventionList();
                updateLocalStorage();
                updateStats();
                
                showSyncStatus("Données synchronisées avec succès", true);
            } catch (error) {
                console.error("Erreur de synchronisation:", error);
                showSyncStatus("Échec de synchronisation", false);
            } finally {
                setTimeout(() => {
                    syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Synchroniser';
                }, 1000);
            }
        }
        
        // Manual sync button
        syncBtn.addEventListener('click', syncData);
        
        // Handle page reload - force logout
        window.addEventListener('beforeunload', function() {
            logout();
        });
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Always start with login screen
            loginOverlay.style.display = 'flex';
            mainApp.style.display = 'none';
            sessionStatus.textContent = "Session sécurisée";
            
            // Prevent autocomplete
            usernameInput.autocomplete = "off";
            passwordInput.autocomplete = "off";
            
            // Clear any stored credentials
            usernameInput.value = '';
            passwordInput.value = '';
            
            // Add event listeners to filters
            filterType.addEventListener('change', () => {
                currentPage = 1;
                renderInterventionList();
            });
            
            filterMaintenance.addEventListener('change', () => {
                currentPage = 1;
                renderInterventionList();
            });
            
            filterStatus.addEventListener('change', () => {
                currentPage = 1;
                renderInterventionList();
            });
            
            searchInput.addEventListener('input', () => {
                currentPage = 1;
                renderInterventionList();
            });
            
            // Pagination navigation
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderInterventionList();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderInterventionList();
                }
            });
            
            // Items per page selector
            itemsPerPageSelect.addEventListener('change', () => {
                itemsPerPage = parseInt(itemsPerPageSelect.value);
                currentPage = 1;
                renderInterventionList();
            });
        });
        
        // Show sync status
        function showSyncStatus(message, isSuccess) {
            // Remove existing status
            const existingStatus = document.querySelector('.sync-status');
            if (existingStatus) existingStatus.remove();
            
            const statusEl = document.createElement('div');
            statusEl.className = 'sync-status';
            statusEl.innerHTML = `<i class="fas ${isSuccess ? 'fa-check-circle sync-success' : 'fa-times-circle sync-error'}"></i> ${message}`;
            
            document.body.appendChild(statusEl);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                statusEl.remove();
            }, 3000);
        }
        
        // Simulate API response for GitHub Pages environment
        window.fetch = (function(originalFetch) {
            return function(url, options) {
                // Intercept API calls
                if (url.includes('api/sync')) {
                    return new Promise((resolve) => {
                        // Simulate network delay
                        setTimeout(() => {
                            // Create a realistic response
                            const response = new Response(JSON.stringify({
                                status: 'success',
                                message: 'Synchronisation réussie',
                                interventions: interventions,
                                lastSync: new Date().toISOString()
                            }), {
                                status: 200,
                                statusText: 'OK',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            resolve(response);
                        }, 800);
                    });
                }
                
                // For other URLs, use the original fetch
                return originalFetch.apply(this, arguments);
            };
        })(window.fetch);
    </script>
</body>
</html>