<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCAPCB - Gestion de Maintenance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0d0d0d, #1a1a1a);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Login overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .login-form {
            background: rgba(25, 25, 35, 0.95);
            padding: 40px;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.5);
            border: 2px solid #e74c3c;
            text-align: center;
        }
        
        .login-title {
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: #e74c3c;
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.7);
        }
        
        .login-input-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .login-input-group label {
            display: block;
            text-align: left;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ecf0f1;
            font-size: 1.1rem;
        }
        
        .login-input-group input {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: none;
            background: rgba(40, 40, 50, 0.95);
            color: white;
            font-size: 1.1rem;
            border: 1px solid #444;
        }
        
        .login-input-group input:focus {
            outline: 2px solid #e74c3c;
        }
        
        .login-btn {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
            font-weight: 700;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background: linear-gradient(to right, #c0392b, #a93226);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: none; /* Hidden until login */
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(15, 15, 25, 0.95);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            border: 1px solid #333;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .logo-circle {
            width: 90px;
            height: 90px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            box-shadow: 0 0 25px rgba(231, 76, 60, 0.6);
            border: 3px solid #fff;
        }
        
        .logo-text {
            font-size: 3.2rem;
            font-weight: 900;
            letter-spacing: 3px;
            color: #fff;
            text-shadow: 0 0 15px rgba(231, 76, 60, 0.8);
        }
        
        .subtitle {
            font-size: 1.3rem;
            color: #ecf0f1;
            margin-top: 10px;
            max-width: 800px;
            margin: 15px auto 0;
            line-height: 1.6;
        }
        
        .header-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            background: linear-gradient(to right, #27ae60, #2ecc71);
            color: white;
            font-weight: 700;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .toggle-btn {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
            font-weight: 700;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .logout-btn {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
            font-weight: 700;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .sync-btn {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
            color: white;
            font-weight: 700;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover, .toggle-btn:hover, .logout-btn:hover, .sync-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .export-btn:hover {
            background: linear-gradient(to right, #219653, #27ae60);
        }
        
        .toggle-btn:hover {
            background: linear-gradient(to right, #2980b9, #2573a7);
        }
        
        .logout-btn:hover {
            background: linear-gradient(to right, #c0392b, #a93226);
        }
        
        .sync-btn:hover {
            background: linear-gradient(to right, #8e44ad, #7d3c98);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 25px;
            margin-top: 20px;
        }
        
        .form-section, .list-section {
            background: rgba(25, 25, 35, 0.95);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
        }
        
        .section-title {
            font-size: 1.6rem;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e74c3c;
            color: #ecf0f1;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 12px;
            color: #e74c3c;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ecf0f1;
            font-size: 1.1rem;
        }
        
        input, select, textarea, button {
            width: 100%;
            padding: 13px;
            border-radius: 8px;
            border: none;
            background: rgba(40, 40, 50, 0.95);
            color: white;
            font-size: 1.05rem;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: 2px solid #e74c3c;
            background: rgba(50, 50, 60, 0.95);
        }
        
        button {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            background: linear-gradient(to right, #c0392b, #a93226);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .equipment-list {
            margin: 15px 0;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(35, 35, 45, 0.95);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #333;
        }
        
        .equipment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #444;
            background: rgba(45, 45, 55, 0.9);
            margin-bottom: 8px;
            border-radius: 6px;
        }
        
        .equipment-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .remove-equipment {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .remove-equipment:hover {
            background: #c0392b;
        }
        
        .intervention-list {
            margin-top: 20px;
        }
        
        .intervention-card {
            background: rgba(35, 35, 45, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #e74c3c;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }
        
        .intervention-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        
        .intervention-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .intervention-title {
            font-weight: 700;
            font-size: 1.3rem;
            color: #ecf0f1;
        }
        
        .intervention-type {
            padding: 6px 15px;
            border-radius: 30px;
            font-size: 0.95rem;
            font-weight: 700;
        }
        
        .electrique { background: #3498db; }
        .mecanique { background: #2ecc71; }
        .servise-general { background: #9b59b6; }
        .preventif { background: #f1c40f; color: #2c3e50; }
        .corective { background: #e67e22; }
        .annule { background: #7f8c8d; }
        
        .intervention-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 0.95rem;
            color: #bdc3c7;
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-weight: 600;
            color: #ecf0f1;
            font-size: 1.1rem;
        }
        
        .intervention-description {
            margin: 15px 0;
            padding: 15px;
            background: rgba(40, 40, 50, 0.8);
            border-radius: 8px;
            border-left: 3px solid #e74c3c;
        }
        
        .description-label {
            font-weight: 600;
            color: #e74c3c;
            margin-bottom: 8px;
        }
        
        .intervention-equipment {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        
        .equipment-tag {
            display: inline-block;
            background: rgba(231, 76, 60, 0.25);
            color: #e74c3c;
            padding: 6px 15px;
            border-radius: 30px;
            margin: 6px 6px 6px 0;
            font-size: 0.95rem;
            font-weight: 500;
            border: 1px solid rgba(231, 76, 60, 0.4);
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        
        .delete-intervention {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 18px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .delete-intervention:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .intervention-id {
            color: #95a5a6;
            font-size: 0.9rem;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            color: #bdc3c7;
            font-size: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(15, 15, 25, 0.95);
            border-radius: 10px;
        }
        
        .copyright {
            color: #e74c3c;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(30, 30, 40, 0.95);
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .stat-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: rgba(40, 40, 50, 0.9);
            flex: 1;
            margin: 0 8px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #e74c3c;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #bdc3c7;
        }
        
        .no-interventions {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #95a5a6;
            background: rgba(35, 35, 45, 0.8);
            border-radius: 10px;
            border: 2px dashed #444;
        }
        
        @media (max-width: 1000px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                flex-direction: column;
            }
            
            .stat-card {
                margin: 8px 0;
            }
            
            .header-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        .login-error {
            color: #e74c3c;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 40px;
            cursor: pointer;
            color: #95a5a6;
        }
        
        .security-note {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #95a5a6;
            text-align: center;
        }
        
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 30px;
            background: rgba(25, 25, 35, 0.95);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            border: 1px solid #333;
        }
        
        .sync-success {
            color: #2ecc71;
        }
        
        .sync-error {
            color: #e74c3c;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-planned { background: #3498db; }
        .status-in-progress { background: #f1c40f; color: #2c3e50; }
        .status-completed { background: #2ecc71; }
        .status-canceled { background: #7f8c8d; }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-bar select, .filter-bar input {
            flex: 1;
            min-width: 150px;
        }
        
        .priority-high { border-left: 5px solid #e74c3c; }
        .priority-medium { border-left: 5px solid #f1c40f; }
        .priority-low { border-left: 5px solid #3498db; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-form">
            <div class="logo">
                <div class="logo-circle">
                    <span style="font-size: 2.5rem; font-weight: bold;">S</span>
                </div>
                <div class="logo-text">SCAPCB</div>
            </div>
            <h2 class="login-title">Accès Administrateur</h2>
            <div class="login-input-group">
                <label for="username"><i class="fas fa-user"></i> Nom d'utilisateur</label>
                <input type="text" id="username" placeholder="Entrez votre nom d'utilisateur" autocomplete="off">
            </div>
            <div class="login-input-group">
                <label for="password"><i class="fas fa-lock"></i> Mot de passe</label>
                <input type="password" id="password" placeholder="Entrez votre mot de passe" autocomplete="off">
                <span class="password-toggle" id="passwordToggle">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <button class="login-btn" id="loginBtn">Se Connecter</button>
            <div class="login-error" id="loginError">Identifiants incorrects. Veuillez réessayer.</div>
            <div class="security-note">
                <i class="fas fa-shield-alt"></i> Veuillez saisir vos identifiants de connexion
            </div>
        </div>
    </div>
    
    <!-- Main Application (hidden until login) -->
    <div class="container" id="mainApp">
        <header>
            <div class="logo">
                <div class="logo-circle">
                    <span style="font-size: 2.5rem; font-weight: bold;">S</span>
                </div>
                <div class="logo-text">SCAPCB</div>
            </div>
            <h1>Système Centralisé d'Administration des Procédures de Contrôle des Bris</h1>
            <p class="subtitle">Application de gestion des interventions de maintenance électrique, mécanique et générale avec suivi des maintenances préventives, correctives et annulées</p>
            
            <div class="header-buttons">
                <button class="export-btn" id="exportExcel">
                    <i class="fas fa-file-excel"></i> Exporter vers Excel
                </button>
                <button class="sync-btn" id="syncBtn">
                    <i class="fas fa-sync-alt"></i> Synchroniser
                </button>
                <button class="toggle-btn" id="toggleInterventions">
                    <i class="fas fa-eye-slash"></i> Masquer les Interventions
                </button>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </button>
            </div>
        </header>
        
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Interventions Total</div>
                <div class="stat-value" id="totalInterventions">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">En Cours</div>
                <div class="stat-value" id="inProgress">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Terminées</div>
                <div class="stat-value" id="completed">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Équipements</div>
                <div class="stat-value" id="totalEquipment">0</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-tools"></i> Nouvelle Intervention</h2>
                <form id="interventionForm">
                    <div class="form-group">
                        <label for="user"><i class="fas fa-user"></i> Utilisateur</label>
                        <input type="text" id="user" required placeholder="Nom de l'utilisateur">
                    </div>
                    
                    <div class="form-group">
                        <label for="matricule"><i class="fas fa-id-card"></i> Matricule</label>
                        <input type="text" id="matricule" required placeholder="Matricule">
                    </div>
                    
                    <div class="form-group">
                        <label for="interventionType"><i class="fas fa-bolt"></i> Type d'intervention</label>
                        <select id="interventionType" required>
                            <option value="">Sélectionner un type</option>
                            <option value="electrique">Maintenance Électrique</option>
                            <option value="mecanique">Maintenance Mécanique</option>
                            <option value="servise-general">Service Général</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenanceType"><i class="fas fa-cogs"></i> Type de maintenance</label>
                        <select id="maintenanceType" required>
                            <option value="">Sélectionner un type</option>
                            <option value="preventif">Maintenance Préventive</option>
                            <option value="corective">Maintenance Corrective</option>
                            <option value="annule">Intervention Annulée</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="priority"><i class="fas fa-exclamation-triangle"></i> Priorité</label>
                        <select id="priority" required>
                            <option value="">Sélectionner une priorité</option>
                            <option value="high">Haute</option>
                            <option value="medium">Moyenne</option>
                            <option value="low">Basse</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="description"><i class="fas fa-file-alt"></i> Description</label>
                        <textarea id="description" placeholder="Décrivez l'intervention en détail..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="startDate"><i class="fas fa-play-circle"></i> Début d'intervention</label>
                        <input type="datetime-local" id="startDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate"><i class="fas fa-stop-circle"></i> Fin d'intervention</label>
                        <input type="datetime-local" id="endDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="equipment"><i class="fas fa-microchip"></i> Équipement</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="equipment" placeholder="Nom de l'équipement">
                            <button type="button" id="addEquipment" style="width: auto;"><i class="fas fa-plus"></i> Ajouter</button>
                        </div>
                    </div>
                    
                    <div class="equipment-list" id="equipmentList">
                        <p style="text-align: center; color: #95a5a6; padding: 10px;">Aucun équipement ajouté</p>
                    </div>
                    
                    <button type="submit"><i class="fas fa-save"></i> Enregistrer l'intervention</button>
                </form>
            </div>
            
            <div class="list-section" id="interventionListSection">
                <h2 class="section-title"><i class="fas fa-list"></i> Interventions Enregistrées</h2>
                
                <div class="filter-bar">
                    <select id="filterType">
                        <option value="">Tous les types</option>
                        <option value="electrique">Électrique</option>
                        <option value="mecanique">Mécanique</option>
                        <option value="servise-general">Service Général</option>
                    </select>
                    
                    <select id="filterMaintenance">
                        <option value="">Toutes les maintenances</option>
                        <option value="preventif">Préventive</option>
                        <option value="corective">Corrective</option>
                        <option value="annule">Annulée</option>
                    </select>
                    
                    <select id="filterStatus">
                        <option value="">Tous les statuts</option>
                        <option value="planned">Planifiée</option>
                        <option value="in-progress">En cours</option>
                        <option value="completed">Terminée</option>
                    </select>
                    
                    <input type="text" id="searchInput" placeholder="Rechercher...">
                </div>
                
                <div class="intervention-list" id="interventionList">
                    <div class="no-interventions">
                        <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <p>Aucune intervention enregistrée</p>
                        <p>Commencez par ajouter une nouvelle intervention</p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Système de Gestion de Maintenance &copy; <span class="copyright">HAMADA 2025</span></p>
            <p>SCAPCB - Tous droits réservés | Version 4.0 | <span id="sessionStatus">Session sécurisée</span></p>
        </footer>
    </div>

    <script>
        // Login credentials
        const ADMIN_USERNAME = "admin5513090807";
        const ADMIN_PASSWORD = "5513090807**Aa";
        
        // Configuration Google Sheets
        const SHEET_ID = "1xXgTj0g3Tz5b9Y0xXgTj0g3Tz5b9Y0xXgTj0g3Tz5b9Y0"; // Remplacez par votre ID
        const SHEET_NAME = "Interventions";
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
        
        // DOM elements
        const loginOverlay = document.getElementById('loginOverlay');
        const mainApp = document.getElementById('mainApp');
        const loginBtn = document.getElementById('loginBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const passwordToggle = document.getElementById('passwordToggle');
        const sessionStatus = document.getElementById('sessionStatus');
        const syncBtn = document.getElementById('syncBtn');
        
        // Initialize variables
        let interventions = [];
        let equipmentList = [];
        let nextId = 1;
        let isLoggedIn = false;
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 3;
        
        // Password visibility toggle
        passwordToggle.addEventListener('click', () => {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordToggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                passwordInput.type = 'password';
                passwordToggle.innerHTML = '<i class="fas fa-eye"></i>';
            }
        });
        
        // Login functionality
        loginBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            // Security: limit login attempts
            loginAttempts++;
            if (loginAttempts > MAX_LOGIN_ATTEMPTS) {
                loginError.textContent = "Trop de tentatives échouées. Veuillez réessayer plus tard.";
                loginError.style.display = 'block';
                loginBtn.disabled = true;
                setTimeout(() => {
                    loginBtn.disabled = false;
                    loginAttempts = 0;
                }, 30000); // 30 seconds lockout
                return;
            }
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                // Successful login
                isLoggedIn = true;
                sessionStatus.textContent = "Connecté";
                loginAttempts = 0;
                
                try {
                    // Load data from Google Sheets
                    await loadDataFromGoogleSheets();
                    loginOverlay.style.display = 'none';
                    mainApp.style.display = 'block';
                    renderEquipmentList();
                    renderInterventionList();
                    updateStats();
                } catch (error) {
                    console.error("Erreur de chargement:", error);
                    // Fallback to localStorage if online loading fails
                    const storedData = localStorage.getItem('appData');
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        interventions = parsedData.interventions || [];
                        nextId = parsedData.nextId || 1;
                    }
                    loginOverlay.style.display = 'none';
                    mainApp.style.display = 'block';
                    renderEquipmentList();
                    renderInterventionList();
                    updateStats();
                }
            } else {
                // Failed login
                loginError.textContent = `Identifiants incorrects. Tentatives restantes: ${MAX_LOGIN_ATTEMPTS - loginAttempts}`;
                loginError.style.display = 'block';
                usernameInput.style.border = '2px solid #e74c3c';
                passwordInput.style.border = '2px solid #e74c3c';
                
                // Clear password field
                passwordInput.value = '';
            }
        });
        
        // Logout functionality
        logoutBtn.addEventListener('click', () => {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter?')) {
                logout();
            }
        });
        
        // Logout function
        function logout() {
            isLoggedIn = false;
            sessionStatus.textContent = "Session sécurisée";
            mainApp.style.display = 'none';
            loginOverlay.style.display = 'flex';
            usernameInput.value = '';
            passwordInput.value = '';
            loginError.style.display = 'none';
            usernameInput.style.border = '';
            passwordInput.style.border = '';
            
            // Clear any sensitive data from memory
            interventions = [];
            equipmentList = [];
            nextId = 1;
        }
        
        // Toggle interventions button
        const toggleBtn = document.getElementById('toggleInterventions');
        const interventionListSection = document.getElementById('interventionListSection');
        let interventionsVisible = true;
        
        toggleBtn.addEventListener('click', () => {
            interventionsVisible = !interventionsVisible;
            
            if (interventionsVisible) {
                interventionListSection.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Masquer les Interventions';
            } else {
                interventionListSection.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Afficher les Interventions';
            }
        });
        
        // DOM elements for the main app
        const interventionForm = document.getElementById('interventionForm');
        const addEquipmentBtn = document.getElementById('addEquipment');
        const equipmentInput = document.getElementById('equipment');
        const equipmentListEl = document.getElementById('equipmentList');
        const interventionListEl = document.getElementById('interventionList');
        const exportExcelBtn = document.getElementById('exportExcel');
        
        // Stats elements
        const totalInterventionsEl = document.getElementById('totalInterventions');
        const inProgressEl = document.getElementById('inProgress');
        const completedEl = document.getElementById('completed');
        const totalEquipmentEl = document.getElementById('totalEquipment');
        
        // Filter elements
        const filterType = document.getElementById('filterType');
        const filterMaintenance = document.getElementById('filterMaintenance');
        const filterStatus = document.getElementById('filterStatus');
        const searchInput = document.getElementById('searchInput');
        
        // Add equipment to the list
        addEquipmentBtn.addEventListener('click', () => {
            const equipment = equipmentInput.value.trim();
            if (equipment) {
                equipmentList.push(equipment);
                equipmentInput.value = '';
                renderEquipmentList();
            }
        });
        
        // Render equipment list
        function renderEquipmentList() {
            equipmentListEl.innerHTML = '';
            
            if (equipmentList.length === 0) {
                equipmentListEl.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 10px;">Aucun équipement ajouté</p>';
                return;
            }
            
            equipmentList.forEach((equipment, index) => {
                const item = document.createElement('div');
                item.className = 'equipment-item';
                item.innerHTML = `
                    <span>${equipment}</span>
                    <button class="remove-equipment" data-index="${index}"><i class="fas fa-trash"></i> Supprimer</button>
                `;
                equipmentListEl.appendChild(item);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-equipment').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    equipmentList.splice(index, 1);
                    renderEquipmentList();
                });
            });
        }
        
        // Handle form submission
        interventionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = document.getElementById('user').value;
            const matricule = document.getElementById('matricule').value;
            const interventionType = document.getElementById('interventionType').value;
            const maintenanceType = document.getElementById('maintenanceType').value;
            const priority = document.getElementById('priority').value;
            const description = document.getElementById('description').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!user || !matricule || !interventionType || !maintenanceType || !priority || !startDate || !endDate) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('La date de fin ne peut pas être antérieure à la date de début');
                return;
            }
            
            const newIntervention = {
                id: nextId++,
                user,
                matricule,
                interventionType,
                maintenanceType,
                priority,
                description,
                start: startDate,
                end: endDate,
                equipment: [...equipmentList],
                status: "planned",
                createdAt: new Date().toISOString()
            };
            
            interventions.push(newIntervention);
            equipmentList = [];
            renderEquipmentList();
            renderInterventionList();
            updateLocalStorage();
            updateStats();
            interventionForm.reset();
            
            // Save to Google Sheets
            try {
                await saveToGoogleSheets(newIntervention);
                showSyncStatus("Synchronisé avec succès", true);
            } catch (error) {
                console.error("Erreur de synchronisation:", error);
                showSyncStatus("Échec de synchronisation", false);
            }
            
            alert('Intervention enregistrée avec succès!');
        });
        
        // Render intervention list
        function renderInterventionList() {
            interventionListEl.innerHTML = '';
            
            // Apply filters
            let filteredInterventions = [...interventions];
            
            // Type filter
            if (filterType.value) {
                filteredInterventions = filteredInterventions.filter(i => i.interventionType === filterType.value);
            }
            
            // Maintenance type filter
            if (filterMaintenance.value) {
                filteredInterventions = filteredInterventions.filter(i => i.maintenanceType === filterMaintenance.value);
            }
            
            // Status filter
            if (filterStatus.value) {
                filteredInterventions = filteredInterventions.filter(i => i.status === filterStatus.value);
            }
            
            // Search filter
            if (searchInput.value) {
                const searchTerm = searchInput.value.toLowerCase();
                filteredInterventions = filteredInterventions.filter(i => 
                    i.user.toLowerCase().includes(searchTerm) || 
                    i.matricule.toLowerCase().includes(searchTerm) ||
                    i.description.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredInterventions.length === 0) {
                interventionListEl.innerHTML = '<div class="no-interventions"><i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 20px;"></i><p>Aucune intervention correspondant aux critères</p></div>';
                return;
            }
            
            // Sort by start date (newest first)
            filteredInterventions.sort((a, b) => new Date(b.start) - new Date(a.start));
            
            filteredInterventions.forEach(intervention => {
                const card = document.createElement('div');
                card.className = `intervention-card priority-${intervention.priority}`;
                
                // Map types to French labels
                const interventionTypeMap = {
                    'electrique': 'Électrique',
                    'mecanique': 'Mécanique',
                    'servise-general': 'Service Général'
                };
                
                const maintenanceTypeMap = {
                    'preventif': 'Préventive',
                    'corective': 'Corrective',
                    'annule': 'Annulée'
                };
                
                const statusMap = {
                    'planned': 'Planifiée',
                    'in-progress': 'En Cours',
                    'completed': 'Terminée',
                    'annule': 'Annulée'
                };
                
                const statusClassMap = {
                    'planned': 'status-planned',
                    'in-progress': 'status-in-progress',
                    'completed': 'status-completed',
                    'annule': 'status-canceled'
                };
                
                card.innerHTML = `
                    <div class="intervention-header">
                        <div class="intervention-title">${intervention.user} (${intervention.matricule})</div>
                        <div>
                            <span class="intervention-type ${intervention.interventionType}">${interventionTypeMap[intervention.interventionType]}</span>
                            <span class="intervention-type ${intervention.maintenanceType}">${maintenanceTypeMap[intervention.maintenanceType]}</span>
                            <span class="status-badge ${statusClassMap[intervention.status]}">${statusMap[intervention.status]}</span>
                        </div>
                    </div>
                    
                    <div class="intervention-details">
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-calendar-alt"></i> Début</span>
                            <span class="detail-value">${formatDate(intervention.start)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-calendar-alt"></i> Fin</span>
                            <span class="detail-value">${formatDate(intervention.end)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-clock"></i> Durée</span>
                            <span class="detail-value">${calculateDuration(intervention.start, intervention.end)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="fas fa-exclamation-triangle"></i> Priorité</span>
                            <span class="detail-value" style="text-transform: capitalize;">${intervention.priority}</span>
                        </div>
                    </div>
                    
                    ${intervention.description ? `
                    <div class="intervention-description">
                        <div class="description-label"><i class="fas fa-file-alt"></i> Description:</div>
                        <div>${intervention.description}</div>
                    </div>
                    ` : ''}
                    
                    <div class="intervention-equipment">
                        <div class="detail-label"><i class="fas fa-cog"></i> Équipements:</div>
                        ${intervention.equipment.map(eq => `<span class="equipment-tag">${eq}</span>`).join('')}
                    </div>
                    
                    <div class="card-footer">
                        <span class="intervention-id">ID: #${intervention.id} | Créé le: ${formatDate(intervention.createdAt)}</span>
                        <button class="delete-intervention" data-id="${intervention.id}">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                `;
                
                interventionListEl.appendChild(card);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-intervention').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = parseInt(e.target.closest('button').dataset.id);
                    if (confirm('Êtes-vous sûr de vouloir supprimer cette intervention?')) {
                        interventions = interventions.filter(i => i.id !== id);
                        renderInterventionList();
                        updateLocalStorage();
                        updateStats();
                        
                        try {
                            await deleteFromGoogleSheets(id);
                            showSyncStatus("Synchronisé avec succès", true);
                        } catch (error) {
                            console.error("Erreur de suppression:", error);
                            showSyncStatus("Échec de synchronisation", false);
                        }
                    }
                });
            });
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Calculate duration between two dates
        function calculateDuration(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            const diff = endDate - startDate;
            
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            
            return `${hours}h ${minutes}min`;
        }
        
        // Update stats
        function updateStats() {
            totalInterventionsEl.textContent = interventions.length;
            
            const inProgress = interventions.filter(i => i.status === 'in-progress').length;
            inProgressEl.textContent = inProgress;
            
            const completed = interventions.filter(i => i.status === 'completed').length;
            completedEl.textContent = completed;
            
            // Calculate total equipment
            let totalEquipment = 0;
            interventions.forEach(intervention => {
                totalEquipment += intervention.equipment.length;
            });
            totalEquipmentEl.textContent = totalEquipment;
        }
        
        // Update localStorage
        function updateLocalStorage() {
            const appData = {
                interventions: interventions,
                nextId: nextId
            };
            localStorage.setItem('appData', JSON.stringify(appData));
        }
        
        // Export to Excel functionality
        exportExcelBtn.addEventListener('click', () => {
            if (interventions.length === 0) {
                alert("Aucune intervention à exporter!");
                return;
            }
            
            // Prepare data for export
            const data = interventions.map(intervention => {
                return {
                    ID: intervention.id,
                    Utilisateur: intervention.user,
                    Matricule: intervention.matricule,
                    "Type d'intervention": intervention.interventionType,
                    "Type de maintenance": intervention.maintenanceType,
                    Priorité: intervention.priority,
                    Description: intervention.description,
                    "Début d'intervention": formatDate(intervention.start),
                    "Fin d'intervention": formatDate(intervention.end),
                    Durée: calculateDuration(intervention.start, intervention.end),
                    Équipements: intervention.equipment.join(", "),
                    Statut: intervention.status,
                    "Date de création": formatDate(intervention.createdAt)
                };
            });
            
            // Create worksheet
            const worksheet = XLSX.utils.json_to_sheet(data);
            
            // Create workbook
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Interventions");
            
            // Export to Excel file
            XLSX.writeFile(workbook, "interventions_maintenance.xlsx");
        });
        
        // Handle page reload - force logout
        window.addEventListener('beforeunload', function() {
            logout();
        });
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Always start with login screen
            loginOverlay.style.display = 'flex';
            mainApp.style.display = 'none';
            sessionStatus.textContent = "Session sécurisée";
            
            // Prevent autocomplete
            usernameInput.autocomplete = "off";
            passwordInput.autocomplete = "off";
            
            // Clear any stored credentials
            usernameInput.value = '';
            passwordInput.value = '';
            
            // Add event listeners to filters
            filterType.addEventListener('change', renderInterventionList);
            filterMaintenance.addEventListener('change', renderInterventionList);
            filterStatus.addEventListener('change', renderInterventionList);
            searchInput.addEventListener('input', renderInterventionList);
        });
        
        // Load data from Google Sheets
        async function loadDataFromGoogleSheets() {
            try {
                // Simulate loading data
                const mockData = [
                    {
                        id: 1,
                        user: "Jean Dupont",
                        matricule: "EMP001",
                        interventionType: "electrique",
                        maintenanceType: "preventif",
                        priority: "medium",
                        description: "Contrôle préventif des circuits électriques",
                        start: "2025-06-01T09:00",
                        end: "2025-06-01T12:30",
                        equipment: ["Tableau électrique principal", "Groupe électrogène"],
                        status: "completed",
                        createdAt: "2025-05-28T14:30:00Z"
                    },
                    {
                        id: 2,
                        user: "Marie Lambert",
                        matricule: "EMP002",
                        interventionType: "mecanique",
                        maintenanceType: "corective",
                        priority: "high",
                        description: "Réparation du système hydraulique défectueux",
                        start: "2025-06-05T10:00",
                        end: "2025-06-05T15:00",
                        equipment: ["Presse hydraulique", "Pompe à huile"],
                        status: "in-progress",
                        createdAt: "2025-05-30T09:15:00Z"
                    },
                    {
                        id: 3,
                        user: "Pierre Moreau",
                        matricule: "EMP003",
                        interventionType: "servise-general",
                        maintenanceType: "preventif",
                        priority: "low",
                        description: "Nettoyage et vérification des systèmes de ventilation",
                        start: "2025-06-10T08:00",
                        end: "2025-06-10T16:00",
                        equipment: ["Ventilateurs industriels", "Filtres à air"],
                        status: "planned",
                        createdAt: "2025-06-01T11:20:00Z"
                    }
                ];
                
                interventions = mockData;
                nextId = 4;
                
                // Update local storage
                updateLocalStorage();
                
                return interventions;
            } catch (error) {
                console.error("Erreur de chargement:", error);
                throw error;
            }
        }
        
        // Save to Google Sheets (simulation)
        async function saveToGoogleSheets(intervention) {
            return new Promise((resolve) => {
                setTimeout(() => resolve(), 1000);
            });
        }
        
        // Delete from Google Sheets (simulation)
        async function deleteFromGoogleSheets(id) {
            return new Promise((resolve) => {
                setTimeout(() => resolve(), 800);
            });
        }
        
        // Sync button functionality
        syncBtn.addEventListener('click', async () => {
            syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synchronisation...';
            try {
                await loadDataFromGoogleSheets();
                renderInterventionList();
                updateStats();
                showSyncStatus("Synchronisé avec succès", true);
            } catch (error) {
                console.error("Erreur de synchronisation:", error);
                showSyncStatus("Échec de synchronisation", false);
            } finally {
                setTimeout(() => {
                    syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Synchroniser';
                }, 1000);
            }
        });
        
        // Show sync status
        function showSyncStatus(message, isSuccess) {
            // Remove existing status
            const existingStatus = document.querySelector('.sync-status');
            if (existingStatus) existingStatus.remove();
            
            const statusEl = document.createElement('div');
            statusEl.className = 'sync-status';
            statusEl.innerHTML = `<i class="fas ${isSuccess ? 'fa-check-circle sync-success' : 'fa-times-circle sync-error'}"></i> ${message}`;
            
            document.body.appendChild(statusEl);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                statusEl.remove();
            }, 3000);
        }
    </script>
</body>
</html>