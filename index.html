<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCAPCB - Syst√®me de Gestion de Maintenance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0a, #1a1a1a);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 204, 0, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 119, 255, 0.05) 0%, transparent 20%);
        }
        
        /* Industrial texture overlay */
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(20, 20, 20, 0.8), rgba(10, 10, 10, 0.9)),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffcc00' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            background-size: cover;
            z-index: -1;
        }
        
        /* Login overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .login-form {
            background: rgba(20, 20, 20, 0.95);
            padding: 40px;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.4);
            border: 2px solid #ffcc00;
            text-align: center;
        }
        
        .login-title {
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        .login-input-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .login-input-group label {
            display: block;
            text-align: left;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ddd;
            font-size: 1.1rem;
        }
        
        .login-input-group input {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: none;
            background: rgba(30, 30, 30, 0.95);
            color: white;
            font-size: 1.1rem;
            border: 1px solid #444;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.2);
        }
        
        .login-input-group input:focus {
            outline: 2px solid #ffcc00;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.4);
        }
        
        .login-btn {
            background: linear-gradient(to right, #ffcc00, #ff9900);
            color: #222;
            font-weight: 700;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(255, 204, 0, 0.3);
        }
        
        .login-btn:hover {
            background: linear-gradient(to right, #ff9900, #cc7a00);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: none; /* Hidden until login */
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(15, 15, 15, 0.95);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            border: 1px solid #333;
            border-bottom: 3px solid #ffcc00;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .logo-circle {
            width: 90px;
            height: 90px;
            background: linear-gradient(45deg, #0077ff, #0055cc);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            box-shadow: 0 0 25px rgba(0, 119, 255, 0.6);
            border: 3px solid #0077ff;
            position: relative;
            overflow: hidden;
        }
        
        .logo-circle::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.3) 100%);
        }
        
        .logo-text {
            font-size: 3.2rem;
            font-weight: 900;
            letter-spacing: 3px;
            color: #fff;
            text-shadow: 0 0 15px rgba(0, 119, 255, 0.8);
            background: linear-gradient(to right, #ffcc00, #ff9900);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.3rem;
            color: #ddd;
            margin-top: 10px;
            max-width: 800px;
            margin: 15px auto 0;
            line-height: 1.6;
            font-weight: 500;
        }
        
        .header-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            background: linear-gradient(to right, #ffcc00, #ff9900);
            color: #222;
            font-weight: 700;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #ffcc00;
        }
        
        .import-btn {
            background: linear-gradient(to right, #ffcc00, #ff9900);
            color: #222;
            font-weight: 700;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #ffcc00;
        }
        
        .toggle-btn {
            background: linear-gradient(to right, #333, #222);
            color: #ffcc00;
            font-weight: 700;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
        }
        
        .logout-btn {
            background: linear-gradient(to right, #ffcc00, #ff9900);
            color: #222;
            font-weight: 700;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #ffcc00;
        }
        
        .sync-btn {
            background: linear-gradient(to right, #0077ff, #0055cc);
            color: white;
            font-weight: 700;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #0077ff;
        }
        
        .export-btn:hover, .import-btn:hover, .toggle-btn:hover, .logout-btn:hover, .sync-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .export-btn:hover {
            background: linear-gradient(to right, #ff9900, #cc7a00);
        }
        
        .import-btn:hover {
            background: linear-gradient(to right, #ff9900, #cc7a00);
        }
        
        .toggle-btn:hover {
            background: linear-gradient(to right, #222, #111);
            color: #ffcc00;
        }
        
        .logout-btn:hover {
            background: linear-gradient(to right, #ff9900, #cc7a00);
        }
        
        .sync-btn:hover {
            background: linear-gradient(to right, #0055cc, #003399);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 25px;
            margin-top: 20px;
        }
        
        .form-section, .list-section {
            background: rgba(20, 20, 20, 0.95);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
            border-top: 3px solid #ffcc00;
        }
        
        .section-title {
            font-size: 1.6rem;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffcc00;
            color: #ddd;
            display: flex;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .section-title i {
            margin-right: 12px;
            color: #ffcc00;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ddd;
            font-size: 1.1rem;
        }
        
        input, select, textarea, button {
            width: 100%;
            padding: 13px;
            border-radius: 8px;
            border: none;
            background: rgba(30, 30, 30, 0.95);
            color: white;
            font-size: 1.05rem;
            border: 1px solid #444;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: 2px solid #ffcc00;
            background: rgba(40, 40, 40, 0.95);
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
        }
        
        button {
            background: linear-gradient(to right, #ffcc00, #ff9900);
            color: #222;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #ffcc00;
        }
        
        button:hover {
            background: linear-gradient(to right, #ff9900, #cc7a00);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .equipment-list {
            margin: 15px 0;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(25, 25, 25, 0.95);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #333;
        }
        
        .equipment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #444;
            background: rgba(35, 35, 35, 0.9);
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #ffcc00;
        }
        
        .equipment-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .remove-equipment {
            background: #ffcc00;
            color: #222;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .remove-equipment:hover {
            background: #ff9900;
        }
        
        .intervention-list {
            margin-top: 20px;
        }
        
        .intervention-card {
            background: rgba(25, 25, 25, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #0077ff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
            border-top: 1px solid #333;
            position: relative;
        }
        
        .intervention-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #0077ff, #0055cc);
        }
        
        .intervention-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        
        .intervention-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .intervention-title {
            font-weight: 700;
            font-size: 1.3rem;
            color: #fff;
        }
        
        .intervention-type {
            padding: 6px 15px;
            border-radius: 30px;
            font-size: 0.95rem;
            font-weight: 700;
        }
        
        .electrique { background: #0077ff; }
        .mecanique { background: #ffcc00; color: #222; }
        .servise-general { background: #00cc77; }
        .preventif { background: #ffcc00; color: #222; }
        .corective { background: #0077ff; }
        .annule { background: #666; }
        
        .intervention-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 0.95rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-weight: 600;
            color: #fff;
            font-size: 1.1rem;
        }
        
        .intervention-description {
            margin: 15px 0;
            padding: 15px;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 8px;
            border-left: 3px solid #ffcc00;
        }
        
        .description-label {
            font-weight: 600;
            color: #ffcc00;
            margin-bottom: 8px;
        }
        
        .intervention-equipment {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        
        .equipment-tag {
            display: inline-block;
            background: rgba(0, 119, 255, 0.2);
            color: #0077ff;
            padding: 6px 15px;
            border-radius: 30px;
            margin: 6px 6px 6px 0;
            font-size: 0.95rem;
            font-weight: 500;
            border: 1px solid rgba(0, 119, 255, 0.4);
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        
        .delete-intervention, .edit-intervention {
            background: #ffcc00;
            color: #222;
            border: none;
            border-radius: 6px;
            padding: 10px 18px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .edit-intervention {
            background: #0077ff;
            color: white;
        }
        
        .delete-intervention:hover {
            background: #ff9900;
            transform: translateY(-2px);
        }
        
        .edit-intervention:hover {
            background: #0055cc;
            transform: translateY(-2px);
        }
        
        .intervention-id {
            color: #999;
            font-size: 0.9rem;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            color: #aaa;
            font-size: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(15, 15, 15, 0.95);
            border-radius: 10px;
            border-top: 3px solid #ffcc00;
        }
        
        .copyright {
            color: #ffcc00;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(20, 20, 20, 0.95);
            border-radius: 8px;
            border: 1px solid #333;
            border-top: 3px solid #0077ff;
        }
        
        .stat-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: rgba(30, 30, 30, 0.9);
            flex: 1;
            margin: 0 8px;
            border: 1px solid #444;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #ffcc00, #ff9900);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #ffcc00;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
        }
        
        .stat-label {
            font-size: 1rem;
            color: #aaa;
        }
        
        .no-interventions {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #999;
            background: rgba(25, 25, 25, 0.8);
            border-radius: 10px;
            border: 2px dashed #444;
        }
        
        /* Industrial warning strips */
        .industrial-warning {
            height: 10px;
            background: repeating-linear-gradient(
                45deg,
                #ffcc00,
                #ffcc00 10px,
                #000 10px,
                #000 20px
            );
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        @media (max-width: 1000px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                flex-direction: column;
            }
            
            .stat-card {
                margin: 8px 0;
            }
            
            .header-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        .login-error {
            color: #ff3333;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 40px;
            cursor: pointer;
            color: #999;
        }
        
        .security-note {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #999;
            text-align: center;
        }
        
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 30px;
            background: rgba(20, 20, 20, 0.95);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            border: 1px solid #333;
            border-left: 5px solid #ffcc00;
        }
        
        .sync-success {
            color: #2ecc71;
        }
        
        .sync-error {
            color: #ff3333;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-planned { background: #ffcc00; color: #222; }
        .status-in-progress { background: #0077ff; }
        .status-completed { background: #00cc77; }
        .status-canceled { background: #666; }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-bar select, .filter-bar input {
            flex: 1;
            min-width: 150px;
        }
        
        .priority-high { border-left: 5px solid #ff3333; }
        .priority-medium { border-left: 5px solid #ffcc00; }
        .priority-low { border-left: 5px solid #0077ff; }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }
        
        .cancel-btn {
            background: #666 !important;
        }
        
        .update-btn {
            background: linear-gradient(to right, #ff9900, #cc7a00) !important;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .device-badge {
            background: rgba(0, 119, 255, 0.2);
            color: #0077ff;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
            border: 1px solid rgba(0, 119, 255, 0.5);
        }
        
        /* Industrial elements */
        .rivet {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #666;
            border-radius: 50%;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        
        .rivet-top-left {
            top: 10px;
            left: 10px;
        }
        
        .rivet-top-right {
            top: 10px;
            right: 10px;
        }
        
        .rivet-bottom-left {
            bottom: 10px;
            left: 10px;
        }
        
        .rivet-bottom-right {
            bottom: 10px;
            right: 10px;
        }
        
        .steel-plate {
            position: relative;
            border: 1px solid #444;
            background: linear-gradient(to bottom, #2a2a2a, #1a1a1a);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        
        .phare-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 119, 255, 0.2);
            padding: 8px 15px;
            border-radius: 30px;
            font-weight: 600;
            color: #0077ff;
            border: 1px solid rgba(0, 119, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-form">
            <div class="logo">
                <div class="logo-circle">
                    <span style="font-size: 2.5rem; font-weight: bold;">S</span>
                </div>
                <div class="logo-text">SCAPCB</div>
            </div>
            <h2 class="login-title">Le Phare de Cap Bon</h2>
            <div class="login-input-group">
                <label for="username"><i class="fas fa-user"></i> Nom d'utilisateur</label>
                <input type="text" id="username" placeholder="Entrez votre nom d'utilisateur" autocomplete="off">
            </div>
            <div class="login-input-group">
                <label for="password"><i class="fas fa-lock"></i> Mot de passe</label>
                <input type="password" id="password" placeholder="Entrez votre mot de passe" autocomplete="off">
                <span class="password-toggle" id="passwordToggle">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <button class="login-btn" id="loginBtn">Se Connecter</button>
            <div class="login-error" id="loginError">Identifiants incorrects. Veuillez r√©essayer.</div>
            <div class="security-note">
                <i class="fas fa-shield-alt"></i> Syst√®me industriel s√©curis√© - Acc√®s restreint
            </div>
        </div>
    </div>
    
    <!-- Main Application (hidden until login) -->
    <div class="container" id="mainApp">
        <header>
            <div class="industrial-warning"></div>
            <div class="logo">
                <div class="logo-circle">
                    <span style="font-size: 2.5rem; font-weight: bold;">S</span>
                </div>
                <div class="logo-text">SCAPCB</div>
            </div>
            <h1>Syst√®me Centralis√© d'Administration des Proc√©dures de Contr√¥le des Bris</h1>
            <p class="subtitle">Application industrielle de gestion des interventions de maintenance</p>
            
            <div class="header-buttons">
                <button class="export-btn" id="exportExcel">
                    <i class="fas fa-file-excel"></i> Exporter vers Excel
                </button>
                <div class="file-input-container">
                    <button class="import-btn" id="importExcelBtn">
                        <i class="fas fa-file-import"></i> Importer Excel
                    </button>
                    <input type="file" id="importExcel" accept=".xlsx, .xls" style="display: none;">
                </div>
                <button class="sync-btn" id="syncBtn">
                    <i class="fas fa-sync-alt"></i> Synchroniser
                </button>
                <button class="toggle-btn" id="toggleInterventions">
                    <i class="fas fa-eye-slash"></i> Masquer les Interventions
                </button>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </button>
            </div>
            <div class="industrial-warning"></div>
        </header>
        
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Interventions Total</div>
                <div class="stat-value" id="totalInterventions">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">En Cours</div>
                <div class="stat-value" id="inProgress">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Termin√©es</div>
                <div class="stat-value" id="completed">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">√âquipements</div>
                <div class="stat-value" id="totalEquipment">0</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="form-section">
                <div class="rivet rivet-top-left"></div>
                <div class="rivet rivet-top-right"></div>
                <div class="rivet rivet-bottom-left"></div>
                <div class="rivet rivet-bottom-right"></div>
                
                <h2 class="section-title"><i class="fas fa-tools"></i> <span id="formTitle">Nouvelle Intervention</span></h2>
                <form id="interventionForm">
                    <input type="hidden" id="interventionId">
                    
                    <div class="form-group">
                        <label for="user"><i class="fas fa-user"></i> Utilisateur</label>
                        <input type="text" id="user" required placeholder="Nom de l'utilisateur">
                    </div>
                    
                    <div class="form-group">
                        <label for="matricule"><i class="fas fa-id-card"></i> Matricule</label>
                        <input type="text" id="matricule" required placeholder="Matricule">
                    </div>
                    
                    <div class="form-group">
                        <label for="interventionType"><i class="fas fa-bolt"></i> Type d'intervention</label>
                        <select id="interventionType" required>
                            <option value="">S√©lectionner un type</option>
                            <option value="electrique">Maintenance √âlectrique</option>
                            <option value="mecanique">Maintenance M√©canique</option>
                            <option value="servise-general">Service G√©n√©ral</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenanceType"><i class="fas fa-cogs"></i> Type de maintenance</label>
                        <select id="maintenanceType" required>
                            <option value="">S√©lectionner un type</option>
                            <option value="preventif">Maintenance Pr√©ventive</option>
                            <option value="corective">Maintenance Corrective</option>
                            <option value="annule">Intervention Annul√©e</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="priority"><i class="fas fa-exclamation-triangle"></i> Priorit√©</label>
                        <select id="priority" required>
                            <option value="">S√©lectionner une priorit√©</option>
                            <option value="high">Haute</option>
                            <option value="medium">Moyenne</option>
                            <option value="low">Basse</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="status"><i class="fas fa-tasks"></i> Statut</label>
                        <select id="status" required>
                            <option value="planned">Planifi√©e</option>
                            <option value="in-progress">En Cours</option>
                            <option value="completed">Termin√©e</option>
                            <option value="annule">Annul√©e</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="description"><i class="fas fa-file-alt"></i> Description</label>
                        <textarea id="description" placeholder="D√©crivez l'intervention en d√©tail..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="startDate"><i class="fas fa-play-circle"></i> D√©but d'intervention</label>
                        <input type="datetime-local" id="startDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate"><i class="fas fa-stop-circle"></i> Fin d'intervention</label>
                        <input type="datetime-local" id="endDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="equipment"><i class="fas fa-microchip"></i> √âquipement</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="equipment" placeholder="Nom de l'√©quipement">
                            <button type="button" id="addEquipment" style="width: auto;"><i class="fas fa-plus"></i> Ajouter</button>
                        </div>
                    </div>
                    
                    <div class="equipment-list" id="equipmentList">
                        <p style="text-align: center; color: #95a5a6; padding: 10px;">Aucun √©quipement ajout√©</p>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="cancel-btn" id="cancelEdit" style="display: none;">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                        <button type="submit" id="submitBtn">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="list-section" id="interventionListSection">
                <div class="rivet rivet-top-left"></div>
                <div class="rivet rivet-top-right"></div>
                <div class="rivet rivet-bottom-left"></div>
                <div class="rivet rivet-bottom-right"></div>
                
                <h2 class="section-title"><i class="fas fa-list"></i> Interventions Enregistr√©es</h2>
                
                <div class="filter-bar">
                    <select id="filterType">
                        <option value="">Tous les types</option>
                        <option value="electrique">√âlectrique</option>
                        <option value="mecanique">M√©canique</option>
                        <option value="servise-general">Service G√©n√©ral</option>
                    </select>
                    
                    <select id="filterMaintenance">
                        <option value="">Toutes les maintenances</option>
                        <option value="preventif">Pr√©ventive</option>
                        <option value="corective">Corrective</option>
                        <option value="annule">Annul√©e</option>
                    </select>
                    
                    <select id="filterStatus">
                        <option value="">Tous les statuts</option>
                        <option value="planned">Planifi√©e</option>
                        <option value="in-progress">En cours</option>
                        <option value="completed">Termin√©e</option>
                    </select>
                    
                    <input type="text" id="searchInput" placeholder="Rechercher...">
                </div>
                
                <div class="intervention-list" id="interventionList">
                    <div class="no-interventions">
                        <i class="fas fa-industry" style="font-size: 3rem; margin-bottom: 20px; color: #ffcc00;"></i>
                        <p>Aucune intervention enregistr√©e</p>
                        <p>Commencez par ajouter une nouvelle intervention</p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Syst√®me Industriel de Gestion de Maintenance &copy; <span class="copyright">HAMADA 2025</span></p>
            <p>SCAPCB - Le Phare de Cap Bon | Tous droits r√©serv√©s | Version 4.0 | <span id="sessionStatus">Session s√©curis√©e</span></p>
        </footer>
    </div>

    <script>
        // Login credentials
        const ADMIN_USERNAME = "admin";
        const ADMIN_PASSWORD = "5513090807**Aa";
        
        // Configuration
        const API_URL = "https://mohamedvth.github.io/maintenancescapcb/";
        const SYNC_INTERVAL = 30000; // 30 seconds
        
        // DOM elements
        const loginOverlay = document.getElementById('loginOverlay');
        const mainApp = document.getElementById('mainApp');
        const loginBtn = document.getElementById('loginBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const passwordToggle = document.getElementById('passwordToggle');
        const sessionStatus = document.getElementById('sessionStatus');
        const syncBtn = document.getElementById('syncBtn');
        const importExcelBtn = document.getElementById('importExcelBtn');
        const importExcelInput = document.getElementById('importExcel');
        
        // Initialize variables
        let interventions = [];
        let equipmentList = [];
        let nextId = 1;
        let isLoggedIn = false;
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 3;
        let isEditing = false;
        let currentEditId = null;
        let syncInterval = null;
        let deviceId = generateDeviceId();
        
        // Generate unique device ID
        function generateDeviceId() {
            return 'device-' + Math.random().toString(36).substr(2, 9);
        }
        
        // Password visibility toggle
        passwordToggle.addEventListener('click', () => {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordToggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                passwordInput.type = 'password';
                passwordToggle.innerHTML = '<i class="fas fa-eye"></i>';
            }
        });
        
        // Login functionality
        loginBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            // Security: limit login attempts
            loginAttempts++;
            if (loginAttempts > MAX_LOGIN_ATTEMPTS) {
                loginError.textContent = "Trop de tentatives √©chou√©es. Veuillez r√©essayer plus tard.";
                loginError.style.display = 'block';
                loginBtn.disabled = true;
                setTimeout(() => {
                    loginBtn.disabled = false;
                    loginAttempts = 0;
                }, 30000); // 30 seconds lockout
                return;
            }
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                // Successful login
                isLoggedIn = true;
                sessionStatus.textContent = "Connect√©";
                loginAttempts = 0;
                
                try {
                    // Load data from localStorage
                    const storedData = localStorage.getItem('scapcb-data');
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        interventions = parsedData.interventions || [];
                        nextId = parsedData.nextId || 1;
                    }
                    
                    loginOverlay.style.display = 'none';
                    mainApp.style.display = 'block';
                    renderEquipmentList();
                    renderInterventionList();
                    updateStats();
                    
                    // Start sync interval
                    startSyncInterval();
                    
                    // Initial sync
                    syncData();
                } catch (error) {
                    console.error("Erreur de chargement:", error);
                    loginOverlay.style.display = 'none';
                    mainApp.style.display = 'block';
                    renderEquipmentList();
                    renderInterventionList();
                    updateStats();
                    startSyncInterval();
                    syncData();
                }
            } else {
                // Failed login
                loginError.textContent = `Identifiants incorrects. Tentatives restantes: ${MAX_LOGIN_ATTEMPTS - loginAttempts}`;
                loginError.style.display = 'block';
                usernameInput.style.border = '2px solid #ff3333';
                passwordInput.style.border = '2px solid #ff3333';
                
                // Clear password field
                passwordInput.value = '';
            }
        });
        
        // Logout functionality
        logoutBtn.addEventListener('click', () => {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter?')) {
                logout();
            }
        });
        
        // Logout function
        function logout() {
            isLoggedIn = false;
            sessionStatus.textContent = "Session s√©curis√©e";
            mainApp.style.display = 'none';
            loginOverlay.style.display = 'flex';
            usernameInput.value = '';
            passwordInput.value = '';
            loginError.style.display = 'none';
            usernameInput.style.border = '';
            passwordInput.style.border = '';
            
            // Clear any sensitive data from memory
            interventions = [];
            equipmentList = [];
            nextId = 1;
            resetForm();
            
            // Stop sync interval
            stopSyncInterval();
        }
        
        // Start sync interval
        function startSyncInterval() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(syncData, SYNC_INTERVAL);
        }
        
        // Stop sync interval
        function stopSyncInterval() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = null;
        }
        
        // Toggle interventions button
        const toggleBtn = document.getElementById('toggleInterventions');
        const interventionListSection = document.getElementById('interventionListSection');
        let interventionsVisible = true;
        
        toggleBtn.addEventListener('click', () => {
            interventionsVisible = !interventionsVisible;
            
            if (interventionsVisible) {
                interventionListSection.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Masquer les Interventions';
            } else {
                interventionListSection.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Afficher les Interventions';
            }
        });
        
        // DOM elements for the main app
        const interventionForm = document.getElementById('interventionForm');
        const addEquipmentBtn = document.getElementById('addEquipment');
        const equipmentInput = document.getElementById('equipment');
        const equipmentListEl = document.getElementById('equipmentList');
        const interventionListEl = document.getElementById('interventionList');
        const exportExcelBtn = document.getElementById('exportExcel');
        const cancelEditBtn = document.getElementById('cancelEdit');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const interventionIdInput = document.getElementById('interventionId');
        
        // Stats elements
        const totalInterventionsEl = document.getElementById('totalInterventions');
        const inProgressEl = document.getElementById('inProgress');
        const completedEl = document.getElementById('completed');
        const totalEquipmentEl = document.getElementById('totalEquipment');
        
        // Filter elements
        const filterType = document.getElementById('filterType');
        const filterMaintenance = document.getElementById('filterMaintenance');
        const filterStatus = document.getElementById('filterStatus');
        const searchInput = document.getElementById('searchInput');
        
        // Add equipment to the list
        addEquipmentBtn.addEventListener('click', () => {
            const equipment = equipmentInput.value.trim();
            if (equipment) {
                equipmentList.push(equipment);
                equipmentInput.value = '';
                renderEquipmentList();
            }
        });
        
        // Render equipment list
        function renderEquipmentList() {
            equipmentListEl.innerHTML = '';
            
            if (equipmentList.length === 0) {
                equipmentListEl.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 10px;">Aucun √©quipement ajout√©</p>';
                return;
            }
            
            equipmentList.forEach((equipment, index) => {
                const item = document.createElement('div');
                item.className = 'equipment-item';
                item.innerHTML = `
                    <span>${equipment}</span>
                    <button class="remove-equipment" data-index="${index}"><i class="fas fa-trash"></i> Supprimer</button>
                `;
                equipmentListEl.appendChild(item);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-equipment').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    equipmentList.splice(index, 1);
                    renderEquipmentList();
                });
            });
        }
        
        // Handle form submission
        interventionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = document.getElementById('user').value;
            const matricule = document.getElementById('matricule').value;
            const interventionType = document.getElementById('interventionType').value;
            const maintenanceType = document.getElementById('maintenanceType').value;
            const priority = document.getElementById('priority').value;
            const status = document.getElementById('status').value;
            const description = document.getElementById('description').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const id = interventionIdInput.value;
            
            if (!user || !matricule || !interventionType || !maintenanceType || !priority || !status || !startDate || !endDate) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('La date de fin ne peut pas √™tre ant√©rieure √† la date de d√©but');
                return;
            }
            
            if (isEditing && id) {
                // Update existing intervention
                const index = interventions.findIndex(i => i.id == id);
                if (index !== -1) {
                    interventions[index] = {
                        ...interventions[index],
                        user,
                        matricule,
                        interventionType,
                        maintenanceType,
                        priority,
                        status,
                        description,
                        start: startDate,
                        end: endDate,
                        equipment: [...equipmentList],
                        updatedAt: new Date().toISOString(),
                        updatedBy: deviceId
                    };
                    
                    showSyncStatus("Intervention mise √† jour avec succ√®s", true);
                }
            } else {
                // Create new intervention
                const newIntervention = {
                    id: nextId++,
                    user,
                    matricule,
                    interventionType,
                    maintenanceType,
                    priority,
                    status,
                    description,
                    start: startDate,
                    end: endDate,
                    equipment: [...equipmentList],
                    createdAt: new Date().toISOString(),
                    createdBy: deviceId,
                    updatedAt: null,
                    updatedBy: null
                };
                
                interventions.push(newIntervention);
                showSyncStatus("Intervention enregistr√©e avec succ√®s", true);
            }
            
            equipmentList = [];
            renderEquipmentList();
            renderInterventionList();
            updateLocalStorage();
            updateStats();
            resetForm();
            
            // Sync changes
            syncData();
        });
        
        // Reset form to initial state
        function resetForm() {
            interventionForm.reset();
            equipmentList = [];
            renderEquipmentList();
            isEditing = false;
            currentEditId = null;
            formTitle.textContent = "Nouvelle Intervention";
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer';
            cancelEditBtn.style.display = 'none';
            interventionIdInput.value = '';
        }
        
        // Cancel edit mode
        cancelEditBtn.addEventListener('click', resetForm);
        
        // Edit intervention
        function editIntervention(id) {
            const intervention = interventions.find(i => i.id == id);
            if (!intervention) return;
            
            // Fill form with intervention data
            document.getElementById('user').value = intervention.user;
            document.getElementById('matricule').value = intervention.matricule;
            document.getElementById('interventionType').value = intervention.interventionType;
            document.getElementById('maintenanceType').value = intervention.maintenanceType;
            document.getElementById('priority').value = intervention.priority;
            document.getElementById('status').value = intervention.status;
            document.getElementById('description').value = intervention.description || '';
            document.getElementById('startDate').value = intervention.start;
            document.getElementById('endDate').value = intervention.end;
            interventionIdInput.value = intervention.id;
            
            // Set equipment
            equipmentList = [...intervention.equipment];
            renderEquipmentList();
            
            // Change form to edit mode
            isEditing = true;
            currentEditId = id;
            formTitle.textContent = "Modifier Intervention";
            submitBtn.innerHTML = '<i class="fas fa-sync"></i> Mettre √† jour';
            cancelEditBtn.style.display = 'block';
            
            // Scroll to form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Delete intervention
        function deleteIntervention(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette intervention?')) {
                interventions = interventions.filter(i => i.id !== id);
                renderInterventionList();
                updateLocalStorage();
                updateStats();
                showSyncStatus("Intervention supprim√©e avec succ√®s", true);
                
                // If we were editing the deleted item, reset form
                if (isEditing && currentEditId == id) {
                    resetForm();
                }
                
                // Sync changes
                syncData();
            }
        }
        
        // Render intervention list
        function renderInterventionList() {
            interventionListEl.innerHTML = '';
            
            // Apply filters
            let filteredInterventions = [...interventions];
            
            // Type filter
            if (filterType.value) {
                filteredInterventions = filteredInterventions.filter(i => i.interventionType === filterType.value);
            }
            
            // Maintenance type filter
            if (filterMaintenance.value) {
                filteredInterventions = filteredInterventions.filter(i => i.maintenanceType === filterMaintenance.value);
            }
            
            // Status filter
            if (filterStatus.value) {
                filteredInterventions = filteredInterventions.filter(i => i.status === filterStatus.value);
            }
            
            // Search filter
            if (searchInput.value) {
                const searchTerm = searchInput.value.toLowerCase();
                filteredInterventions = filteredInterventions.filter(i => 
                    i.user.toLowerCase().includes(searchTerm) || 
                    i.matricule.toLowerCase().includes(searchTerm) ||
                    (i.description && i.description.toLowerCase().includes(searchTerm)) ||
                    i.equipment.some(eq => eq.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredInterventions.length === 0) {
                interventionListEl.innerHTML = '<div class="no-interventions"><i class="fas fa-industry" style="font-size: 3rem; margin-bottom: 20px; color: #ffcc00;"></i><p>Aucune intervention correspondant aux crit√®res</p></div>';
                return;
            }
            
            // Sort by start date (newest first)
            filteredInterventions.sort((a, b) => new Date(b.start) - new Date(a.start));
            
            filteredInterventions.forEach(intervention => {
                const card = document.createElement('div');
                card.className = `intervention-card priority-${intervention.priority}`;
                
                // Map types to French labels
                const interventionTypeMap = {
                    'electrique': '√âlectrique',
                    'mecanique': 'M√©canique',
                    'servise-general': 'Service G√©n√©ral'
                };
                
                const maintenanceTypeMap = {
                    'preventif': 'Pr√©ventive',
                    'corective': 'Corrective',
                    'annule': 'Annul√©e'
                };
                
                const statusMap = {
                    'planned': 'Planifi√©e',
                    'in-progress': 'En Cours',
                    'completed': 'Termin√©e',
                    'annule': 'Annul√©e'
                };
                
                const statusClassMap = {
                    'planned': 'status-planned',
                    'in-progress': 'status-in-progress',
                    'completed': 'status-completed',
                    'annule': 'status-canceled'
                };
                
                card.innerHTML = `
                    <div class="intervention-header">
                        <div class="intervention-title">${intervention.user} (${intervention.matricule})</div>
                        <div>
                            <span class="intervention-type ${intervention.interventionType}">${interventionTypeMap[intervention.interventionType]}</span>
                            <span class="intervention-type ${intervention.maintenanceType}">${maintenanceTypeMap[intervention.maintenanceType]}</span>
                            <span class="status-badge ${statusClassMap[intervention.status]}">${statusMap[intervention.status]}</span>
                        </div>
                    </div>
                    
                    <div class="intervention-details">
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-calendar-alt"></i> D√©but</span>
                            <span class="detail-value">${formatDate(intervention.start)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-calendar-alt"></i> Fin</span>
                            <span class="detail-value">${formatDate(intervention.end)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="far fa-clock"></i> Dur√©e</span>
                            <span class="detail-value">${calculateDuration(intervention.start, intervention.end)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label"><i class="fas fa-exclamation-triangle"></i> Priorit√©</span>
                            <span class="detail-value" style="text-transform: capitalize;">${intervention.priority}</span>
                        </div>
                    </div>
                    
                    ${intervention.description ? `
                    <div class="intervention-description">
                        <div class="description-label"><i class="fas fa-file-alt"></i> Description:</div>
                        <div>${intervention.description}</div>
                    </div>
                    ` : ''}
                    
                    <div class="intervention-equipment">
                        <div class="detail-label"><i class="fas fa-cog"></i> √âquipements:</div>
                        ${intervention.equipment.map(eq => `<span class="equipment-tag">${eq}</span>`).join('')}
                    </div>
                    
                    <div class="card-footer">
                        <span class="intervention-id">
                            ID: #${intervention.id} 
                            ${intervention.updatedAt ? `| Mise √† jour: ${formatDate(intervention.updatedAt)} <span class="device-badge">${intervention.updatedBy === deviceId ? 'Cet appareil' : 'Autre appareil'}</span>` : `| Cr√©√© le: ${formatDate(intervention.createdAt)} <span class="device-badge">${intervention.createdBy === deviceId ? 'Cet appareil' : 'Autre appareil'}</span>`}
                        </span>
                        <div class="action-buttons">
                            <button class="edit-intervention" data-id="${intervention.id}">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="delete-intervention" data-id="${intervention.id}">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    </div>
                `;
                
                interventionListEl.appendChild(card);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.edit-intervention').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.closest('button').dataset.id);
                    editIntervention(id);
                });
            });
            
            document.querySelectorAll('.delete-intervention').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.closest('button').dataset.id);
                    deleteIntervention(id);
                });
            });
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Calculate duration between two dates
        function calculateDuration(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            const diff = endDate - startDate;
            
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            
            return `${hours}h ${minutes}min`;
        }
        
        // Update stats
        function updateStats() {
            totalInterventionsEl.textContent = interventions.length;
            
            const inProgress = interventions.filter(i => i.status === 'in-progress').length;
            inProgressEl.textContent = inProgress;
            
            const completed = interventions.filter(i => i.status === 'completed').length;
            completedEl.textContent = completed;
            
            // Calculate total equipment
            let totalEquipment = 0;
            interventions.forEach(intervention => {
                totalEquipment += intervention.equipment.length;
            });
            totalEquipmentEl.textContent = totalEquipment;
        }
        
        // Update localStorage
        function updateLocalStorage() {
            const appData = {
                interventions: interventions,
                nextId: nextId,
                lastSync: new Date().toISOString()
            };
            localStorage.setItem('scapcb-data', JSON.stringify(appData));
        }
        
        // Export to Excel functionality
        exportExcelBtn.addEventListener('click', () => {
            if (interventions.length === 0) {
                alert("Aucune intervention √† exporter!");
                return;
            }
            
            // Prepare data for export
            const data = interventions.map(intervention => {
                return {
                    ID: intervention.id,
                    Utilisateur: intervention.user,
                    Matricule: intervention.matricule,
                    "Type d'intervention": intervention.interventionType,
                    "Type de maintenance": intervention.maintenanceType,
                    Priorit√©: intervention.priority,
                    Statut: intervention.status,
                    Description: intervention.description,
                    "D√©but d'intervention": formatDate(intervention.start),
                    "Fin d'intervention": formatDate(intervention.end),
                    Dur√©e: calculateDuration(intervention.start, intervention.end),
                    √âquipements: intervention.equipment.join(", "),
                    "Date de cr√©ation": formatDate(intervention.createdAt),
                    "Cr√©√© par": intervention.createdBy,
                    "Derni√®re mise √† jour": intervention.updatedAt ? formatDate(intervention.updatedAt) : "",
                    "Mis √† jour par": intervention.updatedBy || ""
                };
            });
            
            // Create worksheet
            const worksheet = XLSX.utils.json_to_sheet(data);
            
            // Create workbook
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Interventions");
            
            // Export to Excel file
            XLSX.writeFile(workbook, "interventions_maintenance.xlsx");
        });
        
        // Import Excel functionality
        importExcelBtn.addEventListener('click', () => {
            importExcelInput.click();
        });
        
        importExcelInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first worksheet
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) {
                    alert("Le fichier Excel est vide ou ne contient pas de donn√©es valides");
                    return;
                }
                
                // Map Excel data to intervention format
                const importedInterventions = jsonData.map(row => {
                    // Parse dates from strings
                    const parseDate = (dateStr) => {
                        if (!dateStr) return null;
                        return new Date(dateStr).toISOString();
                    };
                    
                    return {
                        id: row.ID || nextId++,
                        user: row.Utilisateur,
                        matricule: row.Matricule,
                        interventionType: row["Type d'intervention"],
                        maintenanceType: row["Type de maintenance"],
                        priority: row.Priorit√©,
                        status: row.Statut,
                        description: row.Description,
                        start: parseDate(row["D√©but d'intervention"]) || new Date().toISOString(),
                        end: parseDate(row["Fin d'intervention"]) || new Date().toISOString(),
                        equipment: row.√âquipements ? row.√âquipements.split(",").map(eq => eq.trim()) : [],
                        createdAt: parseDate(row["Date de cr√©ation"]) || new Date().toISOString(),
                        createdBy: row["Cr√©√© par"] || deviceId,
                        updatedAt: parseDate(row["Derni√®re mise √† jour"]),
                        updatedBy: row["Mis √† jour par"] || null
                    };
                });
                
                // Merge with existing interventions
                interventions = [...interventions, ...importedInterventions];
                
                // Update nextId
                nextId = Math.max(...interventions.map(i => i.id)) + 1;
                
                // Update UI and storage
                renderInterventionList();
                updateLocalStorage();
                updateStats();
                showSyncStatus(`${importedInterventions.length} interventions import√©es avec succ√®s`, true);
                
                // Reset file input
                importExcelInput.value = '';
                
                // Sync changes
                syncData();
            };
            
            reader.readAsArrayBuffer(file);
        });
        
        // Synchronize data with server
        async function syncData() {
            syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synchronisation...';
            
            try {
                // Get last sync timestamp
                const storedData = localStorage.getItem('scapcb-data');
                const lastSync = storedData ? JSON.parse(storedData).lastSync : null;
                
                // Simulate API call to server
                const response = await fetch(`${API_URL}api/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deviceId: deviceId,
                        interventions: interventions,
                        lastSync: lastSync
                    })
                });
                
                if (!response.ok) throw new Error("Erreur de synchronisation");
                
                const data = await response.json();
                
                // Update interventions with server data
                interventions = data.interventions;
                
                // Update nextId
                nextId = Math.max(...interventions.map(i => i.id), 0) + 1;
                
                // Update UI and storage
                renderInterventionList();
                updateLocalStorage();
                updateStats();
                
                showSyncStatus("Donn√©es synchronis√©es avec succ√®s", true);
            } catch (error) {
                console.error("Erreur de synchronisation:", error);
                showSyncStatus("√âchec de synchronisation", false);
            } finally {
                setTimeout(() => {
                    syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Synchroniser';
                }, 1000);
            }
        }
        
        // Manual sync button
        syncBtn.addEventListener('click', syncData);
        
        // Handle page reload - force logout
        window.addEventListener('beforeunload', function() {
            logout();
        });
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Always start with login screen
            loginOverlay.style.display = 'flex';
            mainApp.style.display = 'none';
            sessionStatus.textContent = "Session s√©curis√©e";
            
            // Prevent autocomplete
            usernameInput.autocomplete = "off";
            passwordInput.autocomplete = "off";
            
            // Clear any stored credentials
            usernameInput.value = '';
            passwordInput.value = '';
            
            // Add event listeners to filters
            filterType.addEventListener('change', renderInterventionList);
            filterMaintenance.addEventListener('change', renderInterventionList);
            filterStatus.addEventListener('change', renderInterventionList);
            searchInput.addEventListener('input', renderInterventionList);
        });
        
        // Show sync status
        function showSyncStatus(message, isSuccess) {
            // Remove existing status
            const existingStatus = document.querySelector('.sync-status');
            if (existingStatus) existingStatus.remove();
            
            const statusEl = document.createElement('div');
            statusEl.className = 'sync-status';
            statusEl.innerHTML = `<i class="fas ${isSuccess ? 'fa-check-circle sync-success' : 'fa-times-circle sync-error'}"></i> ${message}`;
            
            document.body.appendChild(statusEl);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                statusEl.remove();
            }, 3000);
        }
        
        // Simulate API response for GitHub Pages environment
        window.fetch = (function(originalFetch) {
            return function(url, options) {
                // Intercept API calls
                if (url.includes('api/sync')) {
                    return new Promise((resolve) => {
                        // Simulate network delay
                        setTimeout(() => {
                            // Create a realistic response
                            const response = new Response(JSON.stringify({
                                status: 'success',
                                message: 'Synchronisation r√©ussie',
                                interventions: interventions,
                                lastSync: new Date().toISOString()
                            }), {
                                status: 200,
                                statusText: 'OK',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            resolve(response);
                        }, 800);
                    });
                }
                
                // For other URLs, use the original fetch
                return originalFetch.apply(this, arguments);
            };
        })(window.fetch);
    </script>
</body>
</html>